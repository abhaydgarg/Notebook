<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Notebook collections"><link href=https://abhaydgarg.github.io/Notebook/index.html/javascript/ecma3/closure/ rel=canonical><meta name=author content="Abhay Garg"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.2"><title>Closure - Notebook</title><link rel=stylesheet href=../../../assets/stylesheets/application.30686662.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono&display=fallback"><style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=blue> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#closure tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-header-nav__button md-logo"> <i class=md-icon></i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Notebook </span> <span class=md-header-nav__topic> Closure </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-nav__button md-logo"> <i class=md-icon></i> </a> Notebook </label> <div class=md-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../computer-science/ title=CS class=md-nav__link> CS </a> </li> <li class=md-nav__item> <a href=../../../parser/ title=Parser class=md-nav__link> Parser </a> </li> <li class=md-nav__item> <a href=../../../data-structure-and-algorithms/ title="Data structure and algorithms" class=md-nav__link> Data structure and algorithms </a> </li> <li class=md-nav__item> <a href=../../../oops/ title=OOPS class=md-nav__link> OOPS </a> </li> <li class=md-nav__item> <a href=../../../design-patterns/ title="Design patterns" class=md-nav__link> Design patterns </a> </li> <li class=md-nav__item> <a href=../../../regex/ title=Regex class=md-nav__link> Regex </a> </li> <li class=md-nav__item> <a href=../../../git/ title=GIT class=md-nav__link> GIT </a> </li> <li class=md-nav__item> <a href=../../../css/ title=CSS class=md-nav__link> CSS </a> </li> <li class=md-nav__item> <a href=../../../mysql/ title=MySQL class=md-nav__link> MySQL </a> </li> <li class=md-nav__item> <a href=../../../mongodb/ title=MongoDB class=md-nav__link> MongoDB </a> </li> <li class=md-nav__item> <a href=../../ title=Javascript class=md-nav__link> Javascript </a> </li> <li class=md-nav__item> <a href=../../../nodejs/ title=Node.js class=md-nav__link> Node.js </a> </li> <li class=md-nav__item> <a href=../../../expressjs/ title=Express.js class=md-nav__link> Express.js </a> </li> <li class=md-nav__item> <a href=../../../react/ title=React class=md-nav__link> React </a> </li> <li class=md-nav__item> <a href=../../../linters/ title=Linters class=md-nav__link> Linters </a> </li> <li class=md-nav__item> <a href=../../../graphql/ title=GraphQL class=md-nav__link> GraphQL </a> </li> <li class=md-nav__item> <a href=../../../redux-saga/ title="Redux saga" class=md-nav__link> Redux saga </a> </li> <li class=md-nav__item> <a href=../../../rxjs/ title=RxJS class=md-nav__link> RxJS </a> </li> <li class=md-nav__item> <a href=../../../typescript/ title=Typescript class=md-nav__link> Typescript </a> </li> <li class=md-nav__item> <a href=../../../web-security/ title="Web security" class=md-nav__link> Web security </a> </li> <li class=md-nav__item> <a href=../../../react-native/ title="React native" class=md-nav__link> React native </a> </li> <li class=md-nav__item> <a href=../../../rust/ title=Rust class=md-nav__link> Rust </a> </li> <li class=md-nav__item> <a href=../../../python/ title=Python class=md-nav__link> Python </a> </li> <li class=md-nav__item> <a href=../../../php/ title=PHP class=md-nav__link> PHP </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#auto-applicative-or-self-applicative class=md-nav__link> Auto-applicative or Self-applicative </a> </li> <li class=md-nav__item> <a href=#auto-replicative-or-self-replicative class=md-nav__link> Auto-replicative or Self-replicative </a> </li> <li class=md-nav__item> <a href=#funarg-problem class=md-nav__link> Funarg problem </a> </li> <li class=md-nav__item> <a href=#closures class=md-nav__link> Closures </a> </li> <li class=md-nav__item> <a href=#ecmascript-closures-implementation class=md-nav__link> ECMAScript closures implementation </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#one-scope-value-for-them-all class=md-nav__link> One [[Scope]] value for “them all” </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/abhaydgarg/Notebook/tree/master/src/javascript/ecma3/closure.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=closure>Closure<a class=headerlink href=#closure title="Permanent link">&para;</a></h1> <p>As is known, in functional languages (and ECMAScript supports this paradigm and stylistics), functions are <em>data</em>, i.e. they can be <em>assigned to variables</em>, passed as <em>arguments</em> to other functions, <em>returned</em> from functions etc. Such functions have special names and structure.</p> <p>A <em>functional argument (“Funarg”)</em> — is an argument whose value is a function.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>function</span> <span class=nx>exampleFunc</span><span class=p>(</span><span class=nx>funArg</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>funArg</span><span class=p>();</span>
<span class=p>}</span>

<span class=nx>exampleFunc</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;funArg&#39;</span><span class=p>);</span>
<span class=p>});</span>
</pre></div> </td></tr></table> <p>The actual parameter related with the “funarg” in this case is the anonymous function <em>passed</em> to the <code>exampleFunc</code> function. In turn, the function which <em>receives</em> another function as the argument is called a <em><strong>higher-order function (HOF)</strong></em>.</p> <p>Functions which can participate as normal data, i.e. be passed as arguments, receive functional arguments or be returned as functional values, are called <em><strong>first-class functions</strong></em>. In ECMAScript <em>all</em> functions are <em>first-class</em>.</p> <h2 id=auto-applicative-or-self-applicative>Auto-applicative or Self-applicative<a class=headerlink href=#auto-applicative-or-self-applicative title="Permanent link">&para;</a></h2> <p>A function which receives itself as an argument.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>(</span><span class=kd>function</span> <span class=nx>selfApplicative</span><span class=p>(</span><span class=nx>funArg</span><span class=p>)</span> <span class=p>{</span>

  <span class=k>if</span> <span class=p>(</span><span class=nx>funArg</span> <span class=o>&amp;&amp;</span> <span class=nx>funArg</span> <span class=o>===</span> <span class=nx>selfApplicative</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;self-applicative&#39;</span><span class=p>);</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nx>selfApplicative</span><span class=p>(</span><span class=nx>selfApplicative</span><span class=p>);</span>

<span class=p>})();</span>
</pre></div> </td></tr></table> <h2 id=auto-replicative-or-self-replicative>Auto-replicative or Self-replicative<a class=headerlink href=#auto-replicative-or-self-replicative title="Permanent link">&para;</a></h2> <p>A function which returns itself.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>(</span><span class=kd>function</span> <span class=nx>selfReplicative</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=nx>selfReplicative</span><span class=p>;</span>
<span class=p>})();</span>
</pre></div> </td></tr></table> <h2 id=funarg-problem>Funarg problem<a class=headerlink href=#funarg-problem title="Permanent link">&para;</a></h2> <p>In stack-oriented programming languages local variables of functions are stored on a stack which is pushed with these variables and function arguments every time when the function is called.</p> <p>On return from the function the variables are removed from the stack. This model is a big restriction for using functions as functional values (i.e. returning them from parent functions). Mostly this problem appears when a function uses free variables.</p> <p>A <em><strong>free variable</strong></em> is a variable which is used by a function, but is neither a parameter, nor a local variable of the function.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>function</span> <span class=nx>testFn</span><span class=p>()</span> <span class=p>{</span>

  <span class=kd>var</span> <span class=nx>localVar</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

  <span class=kd>function</span> <span class=nx>innerFn</span><span class=p>(</span><span class=nx>innerParam</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>innerParam</span> <span class=o>+</span> <span class=nx>localVar</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=nx>innerFn</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>someFn</span> <span class=o>=</span> <span class=nx>testFn</span><span class=p>();</span>
<span class=nx>someFn</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span> <span class=c1>// 30</span>
</pre></div> </td></tr></table> <p>In this example <code>localVar</code> variable is <em>free</em> for the <code>innerFn</code> function.</p> <p>If this system had use a <em>stack-oriented</em> model for storing local variables, it would mean that on return from <code>testFn</code> function all its local variables would be <em>removed_from the stack. And this would cause an error at </em><code>innerFn</code><em> function activation from the _outside</em>. Moreover, in this particular case, in the stack-oriented implementation, returning of the <code>innerFn</code> function would not be possible at all, since <code>innerFn</code> is also <em>local</em> for <code>testFn</code> and therefore is also removed on returning from the <code>testFn</code>.</p> <p><strong>Another problem</strong> of functional objects is related with passing a function as an argument in a system with dynamic scope implementation.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>z</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>z</span><span class=p>);</span>
<span class=p>}</span>

<span class=nx>foo</span><span class=p>();</span> <span class=c1>// 10 – with using both static and dynamic scope</span>

<span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>

  <span class=kd>var</span> <span class=nx>z</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
  <span class=nx>foo</span><span class=p>();</span> <span class=c1>// 10 – with static scope, 20 – with dynamic scope</span>

<span class=p>})();</span>

<span class=c1>// the same with passing foo</span>
<span class=c1>// as an arguments</span>

<span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>funArg</span><span class=p>)</span> <span class=p>{</span>

  <span class=kd>var</span> <span class=nx>z</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span>
  <span class=nx>funArg</span><span class=p>();</span> <span class=c1>// 10 – with static scope, 30 – with dynamic scope</span>

<span class=p>})(</span><span class=nx>foo</span><span class=p>);</span>
</pre></div> </td></tr></table> <p>We see that in systems with dynamic scope, <em>variable resolution</em> is managed with a <em>dynamic (active) stack of variables</em>. Thus, free variables are searched in the <em>dynamic chain</em> of the <em>current activation</em> — in the place where the function is <em>called</em>, but not in the <em>static (lexical) scope chain</em> which is saved at <em>function creation</em>.</p> <p>And this can lead to ambiguity. Thus, even if <code>z</code> exists (in contrast with the previous example where local variables would be removed from a stack), there is a question: which value of <code>z</code> (i.e. <code>z</code> from which <em>context</em>, from which <em>scope</em>) should be used in various calls of <code>foo</code> function?</p> <p>The described cases are two types of the <em>funarg problem</em> — depending on whether we deal with the <em>functional value</em> returned from a function <em>(upward funarg)</em>, or with the <em>functional argument</em> passed to the function <em>(downward funarg)</em>.</p> <p><strong>For solving this problem (and its subtypes) the concept of a </strong><em><strong>closure</strong></em><strong> was proposed.</strong></p> <h2 id=closures>Closures<a class=headerlink href=#closures title="Permanent link">&para;</a></h2> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// free variable &quot;x&quot; == 20</span>
<span class=p>}</span>

<span class=c1>// Closure for foo</span>
<span class=nx>fooClosure</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>call</span><span class=o>:</span> <span class=nx>foo</span> <span class=c1>// reference to function</span>
  <span class=nx>lexicalEnvironment</span><span class=o>:</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span> <span class=mi>20</span><span class=p>}</span> <span class=c1>// context for searching free variables</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <p>In the example above, <code>fooClosure</code> of course is a pseudo-code whereas in ECMAScript <code>foo</code> function already contains as one of its internal property a scope chain of a context in which it has been created.</p> <p><strong>Closures solution to "Funarg problem".</strong></p> <p>Closure saves its parent variables in the <em>lexical place</em> of the <em>source code</em>, that is — where the function is <em>defined</em>. At next activations of the function, free variables are searched in this saved <em>(closured)</em> context, that we can see in examples above where variable <code>z</code> always should be resolved as <code>10</code> in ECMAScript.</p> <h2 id=ecmascript-closures-implementation>ECMAScript closures implementation<a class=headerlink href=#ecmascript-closures-implementation title="Permanent link">&para;</a></h2> <p>Here it is necessary to notice that ECMAScript uses only static (lexical) scope (whereas in some languages, for example in Perl, variables can be declared using both static or dynamic scope).</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span>
<span class=p>}</span>

<span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>funArg</span><span class=p>)</span> <span class=p>{</span>

  <span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>

  <span class=c1>// variable &quot;x&quot; for funArg is saved statically</span>
  <span class=c1>// from the (lexical) context, in which it was created</span>
  <span class=c1>// therefore:</span>

  <span class=nx>funArg</span><span class=p>();</span> <span class=c1>// 10, but not 20</span>

<span class=p>})(</span><span class=nx>foo</span><span class=p>);</span>
</pre></div> </td></tr></table> <p>Technically, the variables of a parent context are saved in the internal <code>[[Scope]]</code> property of the function. <em>All functions in ECMAScript are closures</em>, since <em>all</em> of them at creation save scope chain of a parent context. The important moment here is that, regardless — whether a function will be activated later or not — the parent scope <em>is already saved</em> to it <em>at creation moment</em>:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// foo is a closure</span>
<span class=nx>foo</span><span class=o>:</span> <span class=o>&lt;</span><span class=nx>FunctionObject</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>{</span>
  <span class=p>[[</span><span class=nx>Call</span><span class=p>]]</span><span class=o>:</span> <span class=o>&lt;</span><span class=nx>code</span> <span class=nx>block</span> <span class=k>of</span> <span class=nx>foo</span><span class=o>&gt;</span><span class=p>,</span>
    <span class=nx>global</span><span class=o>:</span> <span class=p>{</span>
      <span class=nx>x</span><span class=o>:</span> <span class=mi>10</span>
    <span class=p>}</span>
  <span class=p>],</span>
  <span class=p>...</span> <span class=c1>// other properties</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <h3 id=one-scope-value-for-them-all>One <code>[[Scope]]</code> value for “them all”<a class=headerlink href=#one-scope-value-for-them-all title="Permanent link">&para;</a></h3> <p><code>[[Scope]]</code> or parent context is shared among all inner functions. So if any change to parent's variable in any inner function reflect the change in other inner function too.</p> <p>It is necessary to notice that closured <code>[[Scope]]</code> in ECMAScript is the <em>same</em> object for the several inner functions created in this parent context. It means that modifying the closured variable from one closure, <em>reflects</em> on reading this variable in <em>another</em> closure.</p> <p><strong>All </strong><em><strong>inner</strong></em><strong> functions </strong><em><strong>share</strong></em><strong> the </strong><em><strong>same parent</strong></em><strong> scope.</strong></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>firstClosure</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>secondClosure</span><span class=p>;</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>

  <span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>

  <span class=nx>firstClosure</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=o>++</span><span class=nx>x</span><span class=p>;</span> <span class=p>};</span>
  <span class=nx>secondClosure</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=o>--</span><span class=nx>x</span><span class=p>;</span> <span class=p>};</span>

  <span class=nx>x</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=c1>// affection on AO[&quot;x&quot;], which is in [[Scope]] of both closures</span>

  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>firstClosure</span><span class=p>());</span> <span class=c1>// 3, via firstClosure.[[Scope]]</span>
<span class=p>}</span>

<span class=nx>foo</span><span class=p>();</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>firstClosure</span><span class=p>());</span> <span class=c1>// 4</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>secondClosure</span><span class=p>());</span> <span class=c1>// 3</span>
</pre></div> </td></tr></table> <p><strong>Another example:</strong> to illustrate the sharing mechanism of parent's scope.</p> <p>There is a widespread mistake related with this feature. Often programmers get unexpected result, when create functions in a <em>loop</em>, trying to associate with every function the loop’s counter variable, expecting that every function will keep its “own” needed value.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=p>[];</span>

<span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>k</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>data</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>k</span><span class=p>);</span>
  <span class=p>};</span>
<span class=p>}</span>

<span class=nx>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]();</span> <span class=c1>// 3, but not 0</span>
<span class=nx>data</span><span class=p>[</span><span class=mi>1</span><span class=p>]();</span> <span class=c1>// 3, but not 1</span>
<span class=nx>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]();</span> <span class=c1>// 3, but not 2</span>
</pre></div> </td></tr></table> <p>Accordingly, at the moment of function activations or called, last assigned value of <code>k</code> variable, i.e. <code>3</code> is used.</p> <p>Creation of additional enclosing context may help to solve the issue:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=p>[];</span>

<span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>k</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>data</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kd>function</span> <span class=nx>_helper</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span>
    <span class=p>};</span>
  <span class=p>})(</span><span class=nx>k</span><span class=p>);</span> <span class=c1>// pass &quot;k&quot; value</span>
<span class=p>}</span>

<span class=c1>// now it is correct</span>
<span class=nx>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]();</span> <span class=c1>// 0</span>
<span class=nx>data</span><span class=p>[</span><span class=mi>1</span><span class=p>]();</span> <span class=c1>// 1</span>
<span class=nx>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]();</span> <span class=c1>// 2</span>
</pre></div> </td></tr></table> <p>First, the function <code>_helper</code> is created and <em>immediately activated</em> with the argument <code>k</code>.</p> <p>Then, returned value of the <code>_helper</code> function is <em>also a function</em>, and exactly <em>it</em> is saved to the corresponding element of the <code>data</code> array.</p> <p>This technique provides the following effect: being activated, the <code>_helper</code> every time creates a <em>new activation object</em> which has argument <code>x</code>, and the <em>value</em> of this argument is the <em>passed</em> value of <code>k</code> variable.</p> <p>Thus, the <code>[[Scope]]</code> of returned functions is the following:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nx>data</span><span class=p>[</span><span class=mi>0</span><span class=p>].[[</span><span class=nx>Scope</span><span class=p>]]</span> <span class=o>===</span> <span class=p>[</span>
  <span class=p>...</span> <span class=c1>// higher variable objects</span>
  <span class=nx>AO</span> <span class=k>of</span> <span class=nx>the</span> <span class=nx>parent</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span><span class=nx>data</span><span class=o>:</span> <span class=p>[...],</span> <span class=nx>k</span><span class=o>:</span> <span class=mi>3</span><span class=p>},</span>
  <span class=nx>AO</span> <span class=k>of</span> <span class=nx>the</span> <span class=nx>_helper</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span> <span class=mi>0</span><span class=p>}</span>
<span class=p>];</span>

<span class=nx>data</span><span class=p>[</span><span class=mi>1</span><span class=p>].[[</span><span class=nx>Scope</span><span class=p>]]</span> <span class=o>===</span> <span class=p>[</span>
  <span class=p>...</span> <span class=c1>// higher variable objects</span>
  <span class=nx>AO</span> <span class=k>of</span> <span class=nx>the</span> <span class=nx>parent</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span><span class=nx>data</span><span class=o>:</span> <span class=p>[...],</span> <span class=nx>k</span><span class=o>:</span> <span class=mi>3</span><span class=p>},</span>
  <span class=nx>AO</span> <span class=k>of</span> <span class=nx>the</span> <span class=nx>_helper</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span> <span class=mi>1</span><span class=p>}</span>
<span class=p>];</span>

<span class=nx>data</span><span class=p>[</span><span class=mi>2</span><span class=p>].[[</span><span class=nx>Scope</span><span class=p>]]</span> <span class=o>===</span> <span class=p>[</span>
  <span class=p>...</span> <span class=c1>// higher variable objects</span>
  <span class=nx>AO</span> <span class=k>of</span> <span class=nx>the</span> <span class=nx>parent</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span><span class=nx>data</span><span class=o>:</span> <span class=p>[...],</span> <span class=nx>k</span><span class=o>:</span> <span class=mi>3</span><span class=p>},</span>
  <span class=nx>AO</span> <span class=k>of</span> <span class=nx>the</span> <span class=nx>_helper</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span> <span class=mi>2</span><span class=p>}</span>
<span class=p>];</span>
</pre></div> </td></tr></table> <p><strong>In ES6, the above problem can be solved very easily using </strong><code>let</code><strong>, or </strong><code>const</code><strong> variable declarations.</strong></p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>let</span> <span class=nx>data</span> <span class=o>=</span> <span class=p>[];</span>

<span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>k</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>data</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>k</span><span class=p>);</span>
  <span class=p>};</span>
<span class=p>}</span>

<span class=c1>// Also correct output.</span>
<span class=nx>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]();</span> <span class=c1>// 0</span>
<span class=nx>data</span><span class=p>[</span><span class=mi>1</span><span class=p>]();</span> <span class=c1>// 1</span>
<span class=nx>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]();</span> <span class=c1>// 2</span>
</pre></div> </td></tr></table> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Abhay Garg </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.c648116f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>