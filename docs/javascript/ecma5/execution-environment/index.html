<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Notebook collections"><link href=https://abhaydgarg.github.io/Notebook/index.html/javascript/ecma5/execution-environment/ rel=canonical><meta name=author content="Abhay Garg"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.2"><title>Execution environment - Notebook</title><link rel=stylesheet href=../../../assets/stylesheets/application.30686662.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono&display=fallback"><style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=blue> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#execution-environment tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-header-nav__button md-logo"> <i class=md-icon></i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Notebook </span> <span class=md-header-nav__topic> Execution environment </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-nav__button md-logo"> <i class=md-icon></i> </a> Notebook </label> <div class=md-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../computer-science/ title=CS class=md-nav__link> CS </a> </li> <li class=md-nav__item> <a href=../../../parser/ title=Parser class=md-nav__link> Parser </a> </li> <li class=md-nav__item> <a href=../../../data-structure-and-algorithms/ title="Data Structure and Algorithms" class=md-nav__link> Data Structure and Algorithms </a> </li> <li class=md-nav__item> <a href=../../../oops/ title=OOPS class=md-nav__link> OOPS </a> </li> <li class=md-nav__item> <a href=../../../design-patterns/ title="Design Patterns" class=md-nav__link> Design Patterns </a> </li> <li class=md-nav__item> <a href=../../../regex/ title=Regex class=md-nav__link> Regex </a> </li> <li class=md-nav__item> <a href=../../../git/ title=GIT class=md-nav__link> GIT </a> </li> <li class=md-nav__item> <a href=../../../css/ title=CSS class=md-nav__link> CSS </a> </li> <li class=md-nav__item> <a href=../../../linters/ title=Linters class=md-nav__link> Linters </a> </li> <li class=md-nav__item> <a href=../../ title=Javascript class=md-nav__link> Javascript </a> </li> <li class=md-nav__item> <a href=../../../typescript/ title=Typescript class=md-nav__link> Typescript </a> </li> <li class=md-nav__item> <a href=../../../nodejs/ title=Node.js class=md-nav__link> Node.js </a> </li> <li class=md-nav__item> <a href=../../../react/ title=React class=md-nav__link> React </a> </li> <li class=md-nav__item> <a href=../../../react-native/ title="React Native" class=md-nav__link> React Native </a> </li> <li class=md-nav__item> <a href=../../../redux-saga/ title="Redux Saga" class=md-nav__link> Redux Saga </a> </li> <li class=md-nav__item> <a href=../../../expressjs/ title=Express.js class=md-nav__link> Express.js </a> </li> <li class=md-nav__item> <a href=../../../graphql/ title=GraphQL class=md-nav__link> GraphQL </a> </li> <li class=md-nav__item> <a href=../../../rxjs/ title=RxJS class=md-nav__link> RxJS </a> </li> <li class=md-nav__item> <a href=../../../mysql/ title=MySQL class=md-nav__link> MySQL </a> </li> <li class=md-nav__item> <a href=../../../mongodb/ title=MongoDB class=md-nav__link> MongoDB </a> </li> <li class=md-nav__item> <a href=../../../web-security/ title="Web Security" class=md-nav__link> Web Security </a> </li> <li class=md-nav__item> <a href=../../../rust/ title=Rust class=md-nav__link> Rust </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#static-lexical-scope class=md-nav__link> Static (lexical) scope </a> </li> <li class=md-nav__item> <a href=#dynamic-scope class=md-nav__link> Dynamic scope </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/abhaydgarg/Notebook/tree/master/src/javascript/ecma5/execution-environment.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=execution-environment>Execution environment<a class=headerlink href=#execution-environment title="Permanent link">&para;</a></h1> <p>Several encapsulating abstractions (such as <em>namespaces</em>, <em>modules</em>, etc) related with a scope, are invented to provide a better modularity of a system and to avoid <em>naming variables conflicts</em>. In the same respect, there are <em>local variables</em> of <em>functions</em>and local variables of <em>blocks</em>. Such techniques help to <em>increase the abstraction</em> and encapsulate the internal data (not bothering a user of this abstraction with details of the implementation and exact internal variable names).</p> <p>Concept of a scope helps us to use in one program the same name variables but with possibly different meanings and values. From this perspective:</p> <p><em>Scope</em> is an enclosing context in which a variable is associated with a value.</p> <p>We may also say, that this is a <em>logical boundaries</em> in which a <em>variable</em> (or even an <em>expression</em>) has its <em>meaning</em>. For example, a <em>global variable</em>, a <em>local variable</em>, etc, which generally reflects a logical range of a variable <em>lifetime</em> (or <em>extent</em>).</p> <p>Block and function concepts lead us to one of the major scope properties — <em>to nest</em>other scopes or <em>to be nested</em>. Thus, as we’ll see, not all implementations allow nested functions, the same as not all implementations provide block-level scope.</p> <p>Consider the following C example:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// global &quot;x&quot;</span>
<span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=kt>void</span> <span class=nf>foo</span><span class=p>()</span> <span class=p>{</span>

  <span class=c1>// local &quot;x&quot; of &quot;foo&quot; function</span>
  <span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>

  <span class=k>if</span> <span class=p>(</span><span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// local &quot;x&quot; of if-block</span>
    <span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&quot;%d&quot;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span> <span class=c1>// 30</span>
  <span class=p>}</span>

  <span class=n>printf</span><span class=p>(</span><span class=s>&quot;%d&quot;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span> <span class=c1>// 20</span>

<span class=p>}</span>

<span class=n>foo</span><span class=p>();</span>

<span class=n>printf</span><span class=p>(</span><span class=s>&quot;%d&quot;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span> <span class=c1>// 10</span>
</pre></div> </td></tr></table> <p><img alt=nested-scopes.png src=../assets/nested-scopes.png></p> <p>ECMAScript before version 6 (aka ES6 or ES2015) didn’t support block-level scope:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=k>if</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 20</span>
<span class=p>}</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 20</span>
</pre></div> </td></tr></table> <p>ES6 standardized <code>let</code> keyword which creates block-scoped variables:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>let</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=k>if</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 20</span>
<span class=p>}</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 10</span>
</pre></div> </td></tr></table> <p>Previously the “block-scope” could be implemented as an immediately-invoked function expression (IIFE):</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=k>if</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>x</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 20</span>
  <span class=p>})(</span><span class=mi>20</span><span class=p>);</span>
<span class=p>}</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 10</span>
</pre></div> </td></tr></table> <h2 id=static-lexical-scope>Static (lexical) scope<a class=headerlink href=#static-lexical-scope title="Permanent link">&para;</a></h2> <p>In static scoping, an identifier refers to its nearest <em>lexical environment</em>. The word “lexical” in this case relates to a property of a <em>program text</em>. I.e. where <em>lexically</em> in the source text a variable appears (that is, the exact place in the code) — in <em>that scope</em> it will be <em>resolved</em> later at runtime on referencing this variable. The word “environment” implies again something that lexically <em>surrounds</em> the definition.</p> <p>The word “static” relates to ability to determine the scope of an identifier <em>during the parsing stage</em> of a program. That is, if we (by looking at the code) can say <em>before</em> the starting the program, in which scope a variable will be resolved — we deal with a <em>static</em> scope.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>y</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>);</span>
<span class=p>}</span>

<span class=nx>foo</span><span class=p>();</span> <span class=c1>// 10, 20</span>

<span class=kd>function</span> <span class=nx>bar</span><span class=p>()</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>y</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>);</span> <span class=c1>// 10, 30</span>
  <span class=nx>foo</span><span class=p>();</span> <span class=c1>// 10, 20</span>
<span class=p>}</span>

<span class=nx>bar</span><span class=p>();</span>
</pre></div> </td></tr></table> <p>In the example, variable <code>x</code> lexically defined in the global scope — that means at runtime it is resolved also in the global scope, i.e. to value <code>10</code>.</p> <p>In case of the <code>y</code> name we have two definitions. But as we said, always the <em>nearest</em>lexical scope containing the variable is considered. The own scope has the highest priority and is considered the first. Therefore, in case of the <code>bar</code> function, <code>y</code> variable is resolved as <code>30</code>. The local variable <code>y</code> of the <code>bar</code> function is said to <em>shadow</em>the same name variable <code>y</code> of the global scope.</p> <p>However, the same name <code>y</code> is resolved as <code>20</code> in case of <code>foo</code> function — <em>even if</em> it is called <em>inside</em> the <code>bar</code> function, which contains another <code>y</code>. I.e. resolution of an identifier is independent from the environment of a <em>caller</em> (in this case <code>bar</code> is a <em>caller</em> of <code>foo</code>, and <code>foo</code> is a <em>callee</em>). And again, this is because at the moment of <code>foo</code>function <em>definition</em>, the <em>nearest</em> lexical context with the <code>y</code> name — was the global context.</p> <h2 id=dynamic-scope>Dynamic scope<a class=headerlink href=#dynamic-scope title="Permanent link">&para;</a></h2> <p>In contrast with the static scope, <em>dynamic scope</em> assumes that we <em>cannot</em> determine at <em>parsing stage</em>, to which value (in which environment) a variable will be resolved. Usually it means, that the variable is resolved <em>not</em> in the <em>lexical</em> environment, but rather in the <em>dynamically</em> formed <em>global stack of variables</em>. Every met variable declaration just puts the name of the variable onto the stack. After the scope (lifetime) of the variable is finished, the variable is removed (popped) from the stack.</p> <p>That means, that for a <em>single</em> function we may have <em>infinite resolution ways</em> of the <em>same</em> variable name — <em>depending on the context</em> from which the function is <em>called</em>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// *pseudo* code - with dynamic scope</span>

<span class=n>y</span> <span class=o>=</span> <span class=mi>20</span><span class=o>;</span>

<span class=k>procedure</span> <span class=nf>foo</span><span class=p>()</span>
  <span class=n>print</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
<span class=k>end</span>


<span class=c1>// on the stack of the &quot;y&quot; name</span>
<span class=c1>// currently only one value 20</span>
<span class=c1>// {y: [20]}</span>

<span class=n>foo</span><span class=p>()</span> <span class=c1>// 20, OK</span>

<span class=k>procedure</span> <span class=nf>bar</span><span class=p>()</span>

  <span class=c1>// and now on the stack there</span>
  <span class=c1>// are two &quot;y&quot; values: {y: [20, 30]};</span>
  <span class=c1>// the first found (from the top) is taken</span>

  <span class=n>y</span> <span class=o>=</span> <span class=mi>30</span>

  <span class=c1>// therefore:</span>
  <span class=n>foo</span><span class=p>()</span> <span class=c1>// 30!, not 20</span>

<span class=k>end</span>

<span class=n>bar</span><span class=p>()</span>
</pre></div> </td></tr></table> <p>We see that the environment of a <em>caller</em> affects on the variables resolution. Since a function (a <em>callee</em>) may be called from <em>many</em> different locations and with different states, it’s hard to determine the exact environment statically, at parsing stage. That’s why this type of scope is called as <em>dynamic</em>.</p> <p>That is, a <em>dynamically-scoped</em> variable is resolved in the environment of <em>execution</em>, rather than the environment of <em>definition</em> as we have in the static scope.</p> <p>Obviously, with the dynamic scope it’s <em>not possible</em> to create a <em>closure</em> for a variable.</p> <p>Today, most of the modern languages <em>do not use</em> dynamic scope. However, in some languages, and notably in Perl (or some variations of Lisp), a programmer may choose how to define a variable — with static or dynamic scope. <!-- markdownlint-disable MD025 --></p> <h1 id=name-binding>Name binding<a class=headerlink href=#name-binding title="Permanent link">&para;</a></h1> <p><!-- markdownlint-enable MD025 --> Having highly-abstracted languages we usually operate not with low-level addresses to refer some data in memory, but rather with convenient variable names (identifiers), which reflect that data.</p> <p>A <em>name binding</em> is the association of an <em>identifier</em> with an <em>object</em>.</p> <p>An identifier can be <em>bound</em> or <em>unbound</em>. If an identifier is bound to an object, it <em>references</em> this object. The following use of the identifier results the object it’s bound to.</p> <p>With bindings concepts two major operations are related (which often cause confusion in discussing <em>by-reference</em> or <em>by-value</em> strategies of passing arguments and assignment). These operations are <em>rebinding</em> and <em>mutation</em>.</p> <h2 id=rebinding>Rebinding<a class=headerlink href=#rebinding title="Permanent link">&para;</a></h2> <p>A <em>rebinding</em> relates to an <em>identifier</em>. This operation <em>unbinds</em> the identifier (if it was previously bound) from an old object and <em>binds</em> it to another one (to another block of memory). Often (and in ECMAScript in particular) rebinding is implemented via a simple operation of <em>assignment</em>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// bind &quot;foo&quot; to {x: 10} object</span>
<span class=kd>var</span> <span class=nx>foo</span> <span class=o>=</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span> <span class=mi>10</span><span class=p>};</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>.</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 10</span>

<span class=c1>// bind &quot;bar&quot; to the *same* object</span>
<span class=c1>// as &quot;foo&quot; identifier is bound</span>

<span class=kd>var</span> <span class=nx>bar</span> <span class=o>=</span> <span class=nx>foo</span><span class=p>;</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span> <span class=o>===</span> <span class=nx>bar</span><span class=p>);</span> <span class=c1>// true</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>bar</span><span class=p>.</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// OK, also 10</span>

<span class=c1>// and now rebind &quot;foo&quot;</span>
<span class=c1>// to the new object</span>

<span class=nx>foo</span> <span class=o>=</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span> <span class=mi>20</span><span class=p>};</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>.</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 20</span>

<span class=c1>// and &quot;bar&quot; still points</span>
<span class=c1>// to the old object</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>bar</span><span class=p>.</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 10</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span> <span class=o>===</span> <span class=nx>bar</span><span class=p>);</span> <span class=c1>// false</span>
</pre></div> </td></tr></table> <p>Often rebinding is <em>confused</em> with assignment <em>by-reference</em>. One could thought that after assigning the new object to the <code>foo</code> variable in the example above, <code>bar</code> variable would also point to the new object. However, as we see, <code>bar</code> still refers to the old object, meanwhile <code>foo</code> was <em>rebound</em> to the new memory block. The next figure shows these two actions:</p> <p><img alt=rebinding.png src=../assets/rebinding.png></p> <p>Think about bindings not as by-reference, but (from C viewpoint) as <em>by-pointer</em> (or sometimes — <em>by-sharing</em>) operation. Often it’s also called as a special case of <em>by-value</em> where value is an address. Assignment just changes (rebinds) the <em>pointer’s value</em> (the address) from one memory block to another. And when we assign one variable to another we just <em>copy</em> the address of the same object to the second variable. Now two identifiers are said to <em>share</em> the one object. From here the name — <em>by-sharing</em>.</p> <h2 id=mutation>Mutation<a class=headerlink href=#mutation title="Permanent link">&para;</a></h2> <p>In contrast with rebinding, the operation of <em>mutation</em> already affects the <em>content</em> of the object.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// bind an array to the &quot;foo&quot; identifier</span>
<span class=kd>var</span> <span class=nx>foo</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>];</span>

<span class=c1>// and here is a *mutation* of</span>
<span class=c1>// the array object contents</span>
<span class=nx>foo</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>);</span> <span class=c1>// 1,2,3,4</span>

<span class=c1>// also mutations</span>
<span class=nx>foo</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
<span class=nx>foo</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>);</span> <span class=c1>// 0,2,3,4,5</span>
</pre></div> </td></tr></table> <p><img alt=mutation.png src=../assets/mutation.png> <!-- markdownlint-disable MD025 --></p> <h1 id=environment>Environment<a class=headerlink href=#environment title="Permanent link">&para;</a></h1> <p><!-- markdownlint-enable MD025 --> In this section we’ll mention the <em>techniques</em> of the lexical scope implementation. Also, since we operate with highly-abstracted entities and talk about lexical scoping, in the further explanation we’ll mainly use the concept of an <em>environment</em>, rather than <em>scope</em>, since exactly this terminology is used in ES5. E.g. the same — a <em>global environment</em>, a <em>local environment</em> of a function, etc.</p> <h2 id=activation-record-model>Activation record model<a class=headerlink href=#activation-record-model title="Permanent link">&para;</a></h2> <p>Until we have no first-class functions (i.e. such functions which may participate as normal data — we’ll talk about them a bit later) or simply do not allow inner functions, the easiest way to store local variables is to use the call-stack itself.</p> <p>A special data structure of the call-stack which is called an activation record is used as a storage of the environment bindings. Sometimes it’s also called a call-stack frame.</p> <p>Every time a function is activated, its activation record (with formal parameters and local variables) is pushed onto the call-stack. Thus, if the function calls another function (or itself — recursively) another stack-frame is pushed onto the stack. After the context is finished, the activation record is <em>removed</em> (popped) from the stack (which means — all local variables are destroyed). This model is used e.g. in C programming language.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kt>void</span> <span class=nf>foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
  <span class=n>bar</span><span class=p>(</span><span class=mi>30</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>bar</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>int</span> <span class=n>z</span> <span class=o>=</span> <span class=mi>40</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>foo</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</pre></div> </td></tr></table> <p>Then the call-stack has the following modifications:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nx>callStack</span> <span class=o>=</span> <span class=p>[];</span>

<span class=c1>// &quot;foo&quot; function activation</span>
<span class=c1>// record is pushed onto the stack</span>

<span class=nx>callStack</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
  <span class=nx>x</span><span class=o>:</span> <span class=mi>10</span><span class=p>,</span>
  <span class=nx>y</span><span class=o>:</span> <span class=mi>20</span>
<span class=p>});</span>

<span class=c1>// &quot;bar&quot; function activation</span>
<span class=c1>// record is pushed onto the stack</span>

<span class=nx>callStack</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
  <span class=nx>x</span><span class=o>:</span> <span class=mi>30</span><span class=p>,</span>
  <span class=nx>z</span><span class=o>:</span> <span class=mi>40</span>
<span class=p>});</span>

<span class=c1>// callStack at the moment of</span>
<span class=c1>// the &quot;bar&quot; activation</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>callStack</span><span class=p>);</span> <span class=c1>// [{x: 10, y: 20}, {x: 30, z: 40}]</span>

<span class=c1>// &quot;bar&quot; function ends</span>
<span class=nx>callStack</span><span class=p>.</span><span class=nx>pop</span><span class=p>();</span>

<span class=c1>// &quot;foo&quot; function ends</span>
<span class=nx>callStack</span><span class=p>.</span><span class=nx>pop</span><span class=p>();</span>
</pre></div> </td></tr></table> <p>And <em>absolutely the same</em> logical approach of functions execution is used in ECMAScript. However, with some <em>very important differences</em>.</p> <p>First, as we know and said above, for the call-stack concept here stands the <em>execution contexts stack</em> and for the activation record stands (in ES3) the <em>activation object</em>.</p> <p>However, the terminology difference is not so essential in this case. The main difference, is that in contrast with C, ECMAScript does <em>not</em> remove the activation object from the memory if there is a <em>closure</em>. And the most important case is when this closure is some inner function which uses variables of the parent function in which it’s created, and this inner function is returned upwards to the outside.</p> <p>That means that the activation object should be stored <em>not</em> in the <em>stack</em> itself, but rather in the <em>heap</em> (a <em>dynamically allocated memory</em>; sometimes such languages are called <em>heap-based</em> languages — in contrast with <em>stack-based</em> languages). And it is stored there until there are references from closures which use (free) variables from this activation object. Moreover, not only one activation object is saved, but if needed (in case of several nested levels) — <em>all</em> parent activation objects.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>bar</span> <span class=o>=</span> <span class=p>(</span><span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
  <span class=kd>var</span> <span class=nx>y</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
  <span class=k>return</span> <span class=kd>function</span> <span class=nx>bar</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>x</span> <span class=o>+</span> <span class=nx>y</span><span class=p>;</span>
  <span class=p>};</span>
<span class=p>})();</span>

<span class=nx>bar</span><span class=p>();</span> <span class=c1>// 30</span>
</pre></div> </td></tr></table> <p><img alt=call-stack-with-closures.png src=../assets/call-stack-with-closures.png></p> <p>One of the used terminologies in the theory for these activation objects is <em>environment frames</em> (analogy with <em>call-stack frames</em>). We use this terminology to underline the difference of the implementation — that environment frames continue to exist if there are references to them from closures.</p> <h2 id=environment-frames-model>Environment frames model<a class=headerlink href=#environment-frames-model title="Permanent link">&para;</a></h2> <p>As is said, in ECMAScript, in contrast with C, we <em>do have</em> inner functions and closures. Moreover, all functions in ES are the <em>first-class</em>. Let’s recall the definition of such functions and also other definitions of the <em>functional programming</em>. We’ll see that these concepts are closely related with lexical environments model.</p> <p>We’ll also clarify that the problem of <em>closures</em> (or — the “funarg problem” as will be mentioned below) is actually the problem of exactly <em>lexical environments</em>. That’s why in this section we’ll mostly speak about basic concepts of functional languages.</p> <h3 id=first-class-functions>First-class functions<a class=headerlink href=#first-class-functions title="Permanent link">&para;</a></h3> <p>A <em>first-class function</em> is one that may participate as a <em>normal data</em>, i.e. be <em>created literally at runtime</em>, be <em>passed as an argument</em>, or <em>be returned as a value</em> from another function.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// create a function expression</span>
<span class=c1>// dynamically at runtime and</span>
<span class=c1>// bind it to &quot;foo&quot; identifier</span>

<span class=kd>var</span> <span class=nx>foo</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&quot;foo&quot;</span><span class=p>);</span>
<span class=p>};</span>

<span class=c1>// pass it to another function,</span>
<span class=c1>// which in turn is also created</span>
<span class=c1>// at runtime and called immediately</span>
<span class=c1>// right after the creation; result</span>
<span class=c1>// of this function is again bound</span>
<span class=c1>// to the &quot;foo&quot; identifier</span>

<span class=nx>foo</span> <span class=o>=</span> <span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>funArg</span><span class=p>)</span> <span class=p>{</span>

  <span class=c1>// activate the &quot;foo&quot; function</span>
  <span class=nx>funArg</span><span class=p>();</span> <span class=c1>// &quot;foo&quot;</span>

  <span class=c1>// and return it back as a value</span>
  <span class=k>return</span> <span class=nx>funArg</span><span class=p>;</span>

<span class=p>})(</span><span class=nx>foo</span><span class=p>);</span>
</pre></div> </td></tr></table> <h3 id=funargs-and-higher-order-functions>Funargs and higher-order functions<a class=headerlink href=#funargs-and-higher-order-functions title="Permanent link">&para;</a></h3> <p>When a function is passed as an argument, it’s called a <em>“funarg”</em> — an abbreviation of the <em>functional argument</em> concept.</p> <p>In turn, a function which accepts the “funarg” is called a <em>higher-order function (HOF)</em> or, closely to mathematics, an <em>operator</em>.</p> <p>A function which returns another function is called a <em>function with a functional value</em> (or a <em>function-valued</em> function).</p> <p>With these concepts, as we’ll see below, a so-called <em>“funarg-problem”</em> is related. And as also we’ll see shortly, the solution of this problem are exactly <em>closures</em> and <em>lexical environments</em>.</p> <p>In the example above, <code>foo</code> function is a “funarg” which is passed to the <em>anonymous higher-order function</em> (it accepts <code>foo</code> “funarg” by the formal parameter name <code>funArg</code>). This anonymous function in turn returns the <em>functional value</em> — and again the <code>foo</code> function itself. And all these functions are grouped by the <em>first-class functions</em> definition.</p> <h3 id=free-variable>Free variable<a class=headerlink href=#free-variable title="Permanent link">&para;</a></h3> <p>Another important concept which is related with first-class functions and which we should recall — is the concept of a <em>free-variable</em>.</p> <p>A <em>free variable</em> is a variable which is used by a function, but is neither a parameter, nor a local variable of the function.</p> <p>In other words, a free variable is one that is placed not in the <em>own</em> environment, but probably in some <em>surrounding</em> environments. Notice, that a free variable may the same be as <em>bound</em> (i.e. found in some parent environment) or <em>unbound</em>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// Global environment (GE)</span>

<span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>(</span><span class=nx>y</span><span class=p>)</span> <span class=p>{</span>

  <span class=c1>// environment of &quot;foo&quot; function (E1)</span>

  <span class=kd>var</span> <span class=nx>z</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span>

  <span class=kd>function</span> <span class=nx>bar</span><span class=p>(</span><span class=nx>q</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// environment of &quot;bar&quot; function (E2)</span>
    <span class=k>return</span> <span class=nx>x</span> <span class=o>+</span> <span class=nx>y</span> <span class=o>+</span> <span class=nx>z</span> <span class=o>+</span> <span class=nx>q</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// return &quot;bar&quot; to the outside</span>
  <span class=k>return</span> <span class=nx>bar</span><span class=p>;</span>

<span class=p>}</span>

<span class=kd>var</span> <span class=nx>bar</span> <span class=o>=</span> <span class=nx>foo</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span>

<span class=nx>bar</span><span class=p>(</span><span class=mi>40</span><span class=p>);</span> <span class=c1>// 100</span>
</pre></div> </td></tr></table> <p>In this example we have three environments: <code>GE</code>, <code>E1</code> and <code>E2</code>, which correspond respectively to the global object, <code>foo</code> function and <code>bar</code> function.</p> <p>Thus, for the <code>bar</code> function, <code>x</code>, <code>y</code> and <code>z</code> variables are <em>free</em> — they are neither formal parameters, nor local variables of <code>bar</code>.</p> <p>Notice, that <code>foo</code> function <em>does not</em> use free variables. However, since <code>x</code> variable is used inside the <code>bar</code> function, and because <code>bar</code> function is created during <em>execution</em>of the <code>foo</code> function, the later one should nevertheless save the bindings of the parent environment — in order to pass the information about the <code>x</code> binding further to the deeper nested functions (to the <code>bar</code> in our case).</p> <p>Correct and expected result <code>100</code> after the <code>bar</code> function activation means, that <code>bar</code>function somehow <em>remembers</em> the environment of the <code>foo</code> function activation (where internal <code>bar</code> function is <em>created</em>), <em>even if</em> the context of the <code>foo</code> is finished. Repeat again, this is the difference from the stack-based activation record model used in C.</p> <p>Obviously, if we allow nested inner functions and want to have the static (lexical) scope, and at the same time — to have all these functions as <em>first-class</em>, we should <em>save all free variables used by a function</em> at the moment of the function’s <em>creation</em>.</p> <h3 id=environment-definition>Environment definition<a class=headerlink href=#environment-definition title="Permanent link">&para;</a></h3> <p>The most straightforward and the easiest way to implement such an algorithm, is to save the <em>complete</em> parent environment in which we were created. Later, at our <em>own</em>activation (in this case, at activation of the <code>bar</code> function), we’ll create our <em>own</em> environment, fill it with local variables and parameters, and set as our <em>outer</em> environment the saved one — in order to find free variables there.</p> <p>It is possible to use the term <em>environment</em> either for a <em>single</em> bindings object, or for the <em>whole</em> list of all binding objects corresponding to the deepness of the nested level. In the later case we may call the binding objects as <em>frames</em> of the environment. From this viewpoint:</p> <p>An <em>environment</em> is a sequence of <em>frames</em>. Each frame is a <em>record</em> (possibly empty) of <em>bindings</em>, which associate variable names with their corresponding values.</p> <p>Notice, since this is a generic definition, we use the abstract concept of a <em>record</em>without specifying exact implementation structure — it may be a hash-table placed in the heap, or a stack memory, or even registers of the virtual machine, etc.</p> <p>For example, environment <code>E2</code> from the example above has three frames: own — <code>bar</code>, <code>foo</code> and <code>global</code>. Environment <code>E1</code> contains two frames: <code>foo</code> (own) and the <code>global</code> frame. Global environment <code>GE</code> in turn consists only from one, <code>global</code>, frame.</p> <p><img alt=environment.png src=../assets/environment.png></p> <p>A single frame may contain <em>at most one</em> binding for any variable. Each frame also has a pointer to its <em>enclosing</em> (or an <em>outer</em>) environment. The outer reference of the <em>global</em> frame is <code>null</code>. The value of a variable with respect to an environment is the value given by the binding of the variable in the <em>first</em> frame in the environment that contains a binding for that variable. If no frame in the sequence specifies a binding for the variable, then the variable is said to be <em>unbound</em> in the environment (the case of a <code>ReferenceError</code>).</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=p>(</span><span class=kd>function</span> <span class=nx>foo</span><span class=p>(</span><span class=nx>y</span><span class=p>)</span> <span class=p>{</span>

  <span class=c1>// use of free-bound &quot;x&quot; variable</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span>

  <span class=c1>// own-bound &quot;y&quot; variable</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>y</span><span class=p>);</span> <span class=c1>// 20</span>

  <span class=c1>// and free-unbound variable &quot;z&quot;</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>z</span><span class=p>);</span> <span class=c1>// ReferenceError: &quot;z&quot; is not defined</span>

<span class=p>})(</span><span class=mi>20</span><span class=p>);</span>
</pre></div> </td></tr></table> <p>I.e. backing again to the concept of <em>scopes</em>, this sequence of environment frames (or in a different view — a <em>linked (chained) list</em> of environments) forms something that we may call as a <em>chain of scopes</em>. Not surprisingly, ES3 had exactly this terminology for that — a <em>scope chain</em>.</p> <p>Notice, a <em>one</em> environment may serve as an <em>enclosing</em> environment for <em>several</em> inner environments:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// Global environment (GE)</span>

<span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>

  <span class=c1>// &quot;foo&quot; environment (E1)</span>

  <span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
  <span class=kd>var</span> <span class=nx>y</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span>

  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span> <span class=o>+</span> <span class=nx>y</span><span class=p>);</span>

<span class=p>}</span>

<span class=kd>function</span> <span class=nx>bar</span><span class=p>()</span> <span class=p>{</span>

  <span class=c1>// &quot;bar&quot; environment (E2)</span>

  <span class=kd>var</span> <span class=nx>z</span> <span class=o>=</span> <span class=mi>40</span><span class=p>;</span>

  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span> <span class=o>+</span> <span class=nx>z</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>Thus in pseudo-code:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// global</span>
<span class=nx>GE</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>x</span><span class=o>:</span> <span class=mi>10</span><span class=p>,</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=kc>null</span>
<span class=p>};</span>

<span class=c1>// foo</span>
<span class=nx>E1</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>x</span><span class=o>:</span> <span class=mi>20</span><span class=p>,</span>
  <span class=nx>y</span><span class=o>:</span> <span class=mi>30</span><span class=p>,</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>GE</span>
<span class=p>};</span>

<span class=c1>// bar</span>
<span class=nx>E2</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>z</span><span class=o>:</span> <span class=mi>40</span><span class=p>,</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>GE</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <p><img alt=common-parent-environment.png src=../assets/common-parent-environment.png></p> <h3 id=rules-of-function-creation-and-application>Rules of function creation and application<a class=headerlink href=#rules-of-function-creation-and-application title="Permanent link">&para;</a></h3> <p>From all this we have the generic rules for creating and applying (calling) functions:</p> <p>A function is <em>created</em> relatively to a given environment. The resulting function object is a <em>pair</em> consisting of the <em>code</em> (function body) and a <em>pointer to the environment</em> in which the function was <em>created</em>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// global &quot;x&quot;</span>
<span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=c1>// function &quot;foo&quot; is created relatively</span>
<span class=c1>// to the global environment</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>(</span><span class=nx>y</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>z</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span> <span class=o>+</span> <span class=nx>y</span> <span class=o>+</span> <span class=nx>z</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>Corresponds in the pseudo-code to:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// create &quot;foo&quot; function</span>

<span class=nx>foo</span> <span class=o>=</span> <span class=nx>functionObject</span> <span class=p>{</span>
  <span class=nx>code</span><span class=o>:</span> <span class=s2>&quot;console.log(x + y + z);&quot;</span>
  <span class=nx>environment</span><span class=o>:</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nx>outer</span><span class=o>:</span> <span class=kc>null</span><span class=p>}</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <p><img alt=function-object.png src=../assets/function-object.png></p> <p>Note, the function refers to its environment, and one of the environment bindings — the function — <em>refers back</em> to the function object.</p> <p>A function is <em>called</em> with (or <em>applied</em> to) a set of arguments by constructing a <em>new frame</em>, binding the formal parameters of the function to the arguments of the call, creating bindings for local variables in this frame, and then executing the body of the function in the context of the <em>new environment</em> constructed. The <em>new frame</em>has as its <em>enclosing environment</em> the environment part of the function object being applied.</p> <p>And the application:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// function &quot;foo&quot; is applied</span>
<span class=c1>// to the argument 20</span>

<span class=nx>foo</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span>
</pre></div> </td></tr></table> <p>Corresponds to the following pseudo-code:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// create a new frame with formal</span>
<span class=c1>// parameters and local variables</span>

<span class=nx>fooFrame</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>y</span><span class=o>:</span> <span class=mi>20</span><span class=p>,</span>
  <span class=nx>z</span><span class=o>:</span> <span class=mi>30</span><span class=p>,</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>environment</span>
<span class=p>};</span>

<span class=c1>// and evaluate the code</span>
<span class=c1>// of the &quot;foo&quot; function</span>

<span class=nx>execute</span><span class=p>(</span><span class=nx>foo</span><span class=p>.</span><span class=nx>code</span><span class=p>,</span> <span class=nx>fooFrame</span><span class=p>);</span> <span class=c1>// 60</span>
</pre></div> </td></tr></table> <p><img alt=function-application.png src=../assets/function-application.png> <!-- markdownlint-disable MD025 --></p> <h1 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h1> <p><!-- markdownlint-enable MD025 --> - Concept of an <em>environment</em> is related with a concept of a <em>scope</em>. - In the theory there are two types of scope: <em>dynamic</em> and <em>static</em>. - ECMAScript uses <em>static</em> (lexical) scope. - However, <code>with</code> and <code>eval</code> instructions may be considered as <em>bringing a dynamics</em> to the static scope. - Concepts of scope, environment, activation object, activation record, call-stack frame, environment frame, environment record and even execution context — are all <em>the nearest synonyms</em> and may be used in discussions. Thus, technically in ECMAScript some of them are parts of another — e.g. an environment record is a part of the lexical environment which in turn is a part of the execution context. However, logically in abstract definitions they all may be used nearly equally. It’s normal to say: “a global scope”, “a global environment”, “a global context”, etc. - ECMAScript uses model of the <em>chained environment frames</em>. In ES3 it was called a <em>scope chain</em>. In ES5 as we’ll see an <em>environment frame</em> is called an <em>environment record</em>. - An environment may enclose <em>several</em> inner environments. - Lexical environment are used to implement <em>closures</em> and to solve the <em>funarg problem</em>. - <em>All</em> functions in ECMAScript are <em>first-class</em> and <em>closures</em>.</p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Abhay Garg </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.c648116f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>