<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Notebook collections"><link href=https://abhaydgarg.github.io/Notebook/index.html/javascript/ecma5/lexical-environment-and-ecma5-implementation/ rel=canonical><meta name=author content="Abhay Garg"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.2"><title>Environment record and outer - Notebook</title><link rel=stylesheet href=../../../assets/stylesheets/application.30686662.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono&display=fallback"><style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=blue> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#environment-record-and-outer tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-header-nav__button md-logo"> <i class=md-icon></i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Notebook </span> <span class=md-header-nav__topic> Environment record and outer </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-nav__button md-logo"> <i class=md-icon></i> </a> Notebook </label> <div class=md-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../computer-science/ title=CS class=md-nav__link> CS </a> </li> <li class=md-nav__item> <a href=../../../parser/ title=Parser class=md-nav__link> Parser </a> </li> <li class=md-nav__item> <a href=../../../data-structure-and-algorithms/ title="Data Structure and Algorithms" class=md-nav__link> Data Structure and Algorithms </a> </li> <li class=md-nav__item> <a href=../../../oops/ title=OOPS class=md-nav__link> OOPS </a> </li> <li class=md-nav__item> <a href=../../../design-patterns/ title="Design Patterns" class=md-nav__link> Design Patterns </a> </li> <li class=md-nav__item> <a href=../../../regex/ title=Regex class=md-nav__link> Regex </a> </li> <li class=md-nav__item> <a href=../../../git/ title=GIT class=md-nav__link> GIT </a> </li> <li class=md-nav__item> <a href=../../../css/ title=CSS class=md-nav__link> CSS </a> </li> <li class=md-nav__item> <a href=../../../rest-api/ title="REST API" class=md-nav__link> REST API </a> </li> <li class=md-nav__item> <a href=../../../eslint/ title=ESLint class=md-nav__link> ESLint </a> </li> <li class=md-nav__item> <a href=../../ title=Javascript class=md-nav__link> Javascript </a> </li> <li class=md-nav__item> <a href=../../../nodejs/ title=Node.js class=md-nav__link> Node.js </a> </li> <li class=md-nav__item> <a href=../../../react/ title=React class=md-nav__link> React </a> </li> <li class=md-nav__item> <a href=../../../react-native/ title="React Native" class=md-nav__link> React Native </a> </li> <li class=md-nav__item> <a href=../../../redux-saga/ title="Redux Saga" class=md-nav__link> Redux Saga </a> </li> <li class=md-nav__item> <a href=../../../rxjs/ title=RxJS class=md-nav__link> RxJS </a> </li> <li class=md-nav__item> <a href=../../../mysql/ title=MySQL class=md-nav__link> MySQL </a> </li> <li class=md-nav__item> <a href=../../../mongodb/ title=MongoDB class=md-nav__link> MongoDB </a> </li> <li class=md-nav__item> <a href=../../../firebase/ title=Firebase class=md-nav__link> Firebase </a> </li> <li class=md-nav__item> <a href=../../../web-security/ title="Web Security" class=md-nav__link> Web Security </a> </li> <li class=md-nav__item> <a href=../../../rust/ title=Rust class=md-nav__link> Rust </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#declarative-environment-record class=md-nav__link> Declarative environment record </a> </li> <li class=md-nav__item> <a href=#object-environment-record class=md-nav__link> Object environment record </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/abhaydgarg/Notebook/tree/master/src/javascript/ecma5/lexical-environment-and-ecma5-implementation.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=environment-record-and-outer>Environment record and outer<a class=headerlink href=#environment-record-and-outer title="Permanent link">&para;</a></h1> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>y</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>Then we have two abstract environments corresponding to the global context and the context of the <code>foo</code> function:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// environment of the global context</span>

<span class=nx>globalEnvironment</span> <span class=o>=</span> <span class=p>{</span>

  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span>

    <span class=c1>// built-ins:</span>
    <span class=nb>Object</span><span class=o>:</span> <span class=kd>function</span><span class=p>,</span>
    <span class=nb>Array</span><span class=o>:</span> <span class=kd>function</span><span class=p>,</span>
    <span class=c1>// etc ...</span>

    <span class=c1>// our bindings:</span>
    <span class=nx>x</span><span class=o>:</span> <span class=mi>10</span>

  <span class=p>},</span>

  <span class=nx>outer</span><span class=o>:</span> <span class=kc>null</span> <span class=c1>// no parent environment</span>

<span class=p>};</span>

<span class=c1>// environment of the &quot;foo&quot; function</span>

<span class=nx>fooEnvironment</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span>
    <span class=nx>y</span><span class=o>:</span> <span class=mi>20</span>
  <span class=p>},</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>globalEnvironment</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <p>The <em>outer</em> reference as we can see is used to chain the current environment with the parent one. The parent environment of course may have its own <em>outer</em> link. And the <em>outer</em> link of the <em>global environment</em> is set to <code>null</code>.</p> <p>The global environment is the final link of this <em>chain of scopes</em>. This reminds how the prototypal inheritance works in ES: if a property isn’t found in the object itself, it’s searched in its prototype, then in the prototype of the prototype and so on, until it’s found, either the final link of the prototype chain is considered. The same with environments: the variables (or identifiers) appear in the context stand for the properties, and the <em>outer</em> link stands for the reference to the prototype.</p> <p>A lexical environment as we mentioned may surrounds multiple inner lexical environments. E.g., if a function contains two nested functions then the lexical environments of each of the nested functions will have as their outer environment the environment of the surrounding function.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>

  <span class=kd>var</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

  <span class=kd>function</span> <span class=nx>bar</span><span class=p>()</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=nx>y</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span> <span class=o>+</span> <span class=nx>y</span><span class=p>);</span> <span class=c1>// 30</span>
  <span class=p>}</span>

  <span class=kd>function</span> <span class=nx>baz</span><span class=p>()</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=nx>z</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>x</span> <span class=o>+</span> <span class=nx>y</span><span class=p>);</span> <span class=c1>// 40</span>
  <span class=p>}</span>

<span class=p>}</span>

<span class=c1>// ----- Environments -----</span>

<span class=c1>// &quot;foo&quot; environmnet</span>

<span class=nx>fooEnvironment</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span> <span class=mi>10</span><span class=p>},</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>globalEnvironment</span>
<span class=p>};</span>

<span class=c1>// both &quot;bar&quot; and &quot;baz&quot; have the same outer</span>
<span class=c1>// environment -- the environment of &quot;foo&quot;</span>

<span class=nx>barEnvironment</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span><span class=nx>y</span><span class=o>:</span> <span class=mi>20</span><span class=p>},</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>fooEnvironment</span>
<span class=p>};</span>

<span class=nx>bazEnvironment</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span><span class=nx>z</span><span class=o>:</span> <span class=mi>30</span><span class=p>},</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>fooEnvironment</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <p><strong>ECMAScript defines two types of environment records:</strong> <em>declarative</em> environment records and <em>object</em> environment records.</p> <h2 id=declarative-environment-record>Declarative environment record<a class=headerlink href=#declarative-environment-record title="Permanent link">&para;</a></h2> <p>Declarative environment records are used to handle variables, functions, formal parameters, etc. appeared in function scopes (in this case this is very <strong>activation object</strong> which we know from ES3 series) and catch clauses.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// all: &quot;a&quot;, &quot;b&quot; and &quot;c&quot;</span>
<span class=c1>// bindings are bindings of</span>
<span class=c1>// a declarative record</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
  <span class=kd>function</span> <span class=nx>c</span><span class=p>()</span> <span class=p>{}</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>In case of the <code>catch</code> clause the binding is the exception argument:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>try</span> <span class=p>{</span>
  <span class=p>...</span>
<span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// &quot;e&quot; is a binding of a declarative record</span>
  <span class=p>...</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>In general case the bindings of declarative records are assumed to be stored <em>directly at low level of the implementation</em> (for example, in registers of a virtual machine, thus providing fast access). This is the main difference from the old <em>activation object</em> concept used in ES3.</p> <p>That is, the specification doesn’t require (and even indirectly doesn’t recommend) to implement declarative records as simple objects which are <em>inefficient</em> in this case. The consequence from this fact is that declarative environment records are not assumed to be exposed directly to the user-level, which means we cannot access these bindings as e.g. properties of the record. Actually, we couldn’t also before, even in ES3 — there <em>activation object</em> also was <em>inaccessible</em> directly to a user (except though Rhino implementation which nevertheless exposed it via <code>__parent__</code> property).</p> <p>Potentially, declarative records allow to use complete lexical addressing technique, that is to get the direct access to needed variables without any scope chain lookup — regardless the depth of the nested scope (if the storage is fixed and unchangeable, all variable addresses can be known even at compile time). However, ES5 spec doesn’t mention this fact directly.</p> <p>So once again, the main thing which we should understand why it was needed to replace old <em>activation object</em> concept with the <em>declarative environment record</em> is first of all the <em>efficiency of the implementation</em>.</p> <p>Abstractly, an environment with the declarative record, can be presented in this way (thus, property <code>type</code> is not from the spec, but my explanatory convention):</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nx>environment</span> <span class=o>=</span> <span class=p>{</span>
  <span class=c1>// storage</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span>
    <span class=nx>type</span><span class=o>:</span> <span class=s2>&quot;declarative&quot;</span><span class=p>,</span>
    <span class=c1>// storage</span>
  <span class=p>},</span>
  <span class=c1>// reference to the parent environment</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=o>&lt;</span><span class=p>...</span><span class=o>&gt;</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <h2 id=object-environment-record>Object environment record<a class=headerlink href=#object-environment-record title="Permanent link">&para;</a></h2> <p>In contrast, an <em>object environment record</em> is used to define association of variables and functions appeared in the <em>global context</em> and inside the <code>with</code>-statements. These are exactly those inefficient variable storage implemented as <em>simple objects</em> which we’ve just mentioned above. In this case bindings are the <em>properties of the objects</em>.</p> <p>The object which stores the bindings of such a context is called the <em>binding object</em>.</p> <p>In case of the global context, the variables are associated with the global object itself. Exactly because of this we have the ability to refer them as properties of the global object:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>a</span><span class=p>);</span> <span class=c1>// 10</span>

<span class=c1>// &quot;this&quot; in the global context</span>
<span class=c1>// is the global object itself</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>a</span><span class=p>);</span> <span class=c1>// 10</span>

<span class=c1>// &quot;window&quot; is the reference to the</span>
<span class=c1>// global object in the browser environment</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>a</span><span class=p>);</span> <span class=c1>// 10</span>
</pre></div> </td></tr></table> <p>In case of the <code>with</code> statement, variables can be associated with the properties of the <code>with</code>-object:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>with</span> <span class=p>({</span><span class=nx>a</span><span class=o>:</span> <span class=mi>10</span><span class=p>})</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>a</span><span class=p>);</span> <span class=c1>// 10</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>Every time when <code>with</code> statement is executed a new lexical environment with object environment record is created. Thus, the environment of the running context is set as the <em>outer</em> environment. Then the environment of the running context is <em>replaced</em> with this newly created environment. After the <code>with</code> execution is completed the environment of the context is restored to the previous state:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
<span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>

<span class=kd>with</span> <span class=p>({</span><span class=nx>a</span><span class=o>:</span> <span class=mi>30</span><span class=p>})</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>a</span> <span class=o>+</span> <span class=nx>b</span><span class=p>);</span> <span class=c1>// 50</span>
<span class=p>}</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>a</span> <span class=o>+</span> <span class=nx>b</span><span class=p>);</span> <span class=c1>// 30, restored</span>
</pre></div> </td></tr></table> <p>In pseudo-code:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// initial state</span>
<span class=nx>context</span><span class=p>.</span><span class=nx>lexicalEnvironment</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span><span class=nx>a</span><span class=o>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nx>b</span><span class=o>:</span> <span class=mi>20</span><span class=p>},</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=kc>null</span>
<span class=p>};</span>

<span class=c1>// &quot;with&quot; executed</span>
<span class=nx>previousEnvironment</span> <span class=o>=</span> <span class=nx>context</span><span class=p>.</span><span class=nx>lexicalEnvironment</span><span class=p>;</span>

<span class=nx>withEnvironment</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span><span class=nx>a</span><span class=o>:</span> <span class=mi>30</span><span class=p>},</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>context</span><span class=p>.</span><span class=nx>lexicalEnvironment</span>
<span class=p>};</span>

<span class=c1>// replace current environment</span>
<span class=nx>context</span><span class=p>.</span><span class=nx>lexicalEnvironment</span> <span class=o>=</span> <span class=nx>withEnvironment</span><span class=p>;</span>

<span class=c1>// &quot;with&quot; completed, restore the environment back</span>
<span class=nx>context</span><span class=p>.</span><span class=nx>lexicalEnvironment</span> <span class=o>=</span> <span class=nx>previousEnvironment</span><span class=p>;</span>
</pre></div> </td></tr></table> <p>Absolutely the same effect has a <code>catch</code> clause — it also replaces the running context’s lexical environment with the newly created one, though in contrast with <code>with</code>statement, <code>catch</code> clause as we said uses <em>declarative record</em> but not the <em>object</em>:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>e</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=k>try</span> <span class=p>{</span>
  <span class=k>throw</span> <span class=mi>20</span><span class=p>;</span>
<span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// replace the environment</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span> <span class=c1>// 20</span>
<span class=p>}</span>

<span class=c1>// and now it&#39;s restored back</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span> <span class=c1>// 10</span>
</pre></div> </td></tr></table> <p>with statements often may cause confusions (because of the effect of variables and function declarations hoisting) and some of them are really confusing cases. This is also the reason why the <strong><code>with</code> statement was removed from ES5-strict.</strong></p> <p>Abstractly, an environment with the object environment record, can be presented in this way:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nx>environment</span> <span class=o>=</span> <span class=p>{</span>
  <span class=c1>// storage</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span>
    <span class=nx>type</span><span class=o>:</span> <span class=s2>&quot;object&quot;</span><span class=p>,</span>
    <span class=nx>bindingObject</span><span class=o>:</span> <span class=p>{</span>
      <span class=c1>// storage</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=c1>// reference to the parent environment</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=o>&lt;</span><span class=p>...</span><span class=o>&gt;</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <!-- markdownlint-disable MD025 --> <h1 id=structure-of-execution-context>Structure of execution context<a class=headerlink href=#structure-of-execution-context title="Permanent link">&para;</a></h1> <!-- markdownlint-enbale MD025 --> <p>It’s a little bit different than in ES3 and has the following properties:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nx>ExecutionContextES5</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>ThisBinding</span><span class=o>:</span> <span class=o>&lt;</span><span class=k>this</span> <span class=nx>value</span><span class=o>&gt;</span><span class=p>,</span>
  <span class=nx>VariableEnvironment</span><span class=o>:</span> <span class=p>{</span> <span class=p>...</span> <span class=p>},</span>
  <span class=nx>LexicalEnvironment</span><span class=o>:</span> <span class=p>{</span> <span class=p>...</span> <span class=p>},</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <h2 id=this-binding>This binding<a class=headerlink href=#this-binding title="Permanent link">&para;</a></h2> <p>This value is now called <em>this binding</em> (though, “this value” combination of words is still in ES5 spec). However, beside the terminology change, there are no big changes in semantics (except the <em>strict mode</em>, where <code>this</code> value can be <code>undefined</code>). In the global context, <code>this</code> binding is still the global object itself:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>global</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>global</span><span class=p>.</span><span class=nx>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
<span class=p>})(</span><span class=k>this</span><span class=p>);</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>a</span><span class=p>);</span> <span class=c1>// 10</span>
</pre></div> </td></tr></table> <p>And inside a function context <code>this</code> value is still determined by the form of how the function is <em>called</em>. If it’s called with a reference, then the <em>base value</em> of the reference is used as <code>this</code> value, in all other cases — either global object or <code>undefined</code> in strict mode is used for <code>this</code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>foo</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>bar</span><span class=o>:</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
  <span class=p>};</span>
<span class=p>};</span>

<span class=c1>// --- Reference cases ---</span>

<span class=c1>// with a reference</span>
<span class=nx>foo</span><span class=p>.</span><span class=nx>bar</span><span class=p>();</span> <span class=c1>// &quot;this&quot; is &quot;foo&quot; - the base</span>

<span class=kd>var</span> <span class=nx>bar</span> <span class=o>=</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>bar</span><span class=p>;</span>

<span class=c1>// with the reference</span>
<span class=nx>bar</span><span class=p>();</span> <span class=c1>// &quot;this&quot; is the global, implicit base</span>
<span class=k>this</span><span class=p>.</span><span class=nx>bar</span><span class=p>();</span> <span class=c1>// the same, explicit base, the global</span>

<span class=c1>// with also but another reference</span>
<span class=nx>bar</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>constructor</span><span class=p>();</span> <span class=c1>// &quot;this&quot; is &quot;bar.prototype&quot;</span>

<span class=c1>// --- non-Reference cases ---</span>

<span class=p>(</span><span class=nx>foo</span><span class=p>.</span><span class=nx>bar</span> <span class=o>=</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>bar</span><span class=p>)();</span> <span class=c1>// &quot;this&quot; is &quot;global&quot; or &quot;undefined&quot;</span>
<span class=p>(</span><span class=nx>foo</span><span class=p>.</span><span class=nx>bar</span> <span class=o>||</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>bar</span><span class=p>)();</span> <span class=c1>// &quot;this&quot; is &quot;global&quot; or &quot;undefined&quot;</span>
<span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span> <span class=k>this</span><span class=p>;</span> <span class=p>})();</span> <span class=c1>// &quot;this&quot; is &quot;global&quot; or &quot;undefined&quot;</span>
</pre></div> </td></tr></table> <p>Notice again, in strict mode, it’s not possible anymore to get the global object with such a trick:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
  <span class=s2>&quot;use strict&quot;</span><span class=p>;</span>
  <span class=kd>var</span> <span class=nx>global</span> <span class=o>=</span> <span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=k>this</span><span class=p>;</span> <span class=p>})();</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>global</span><span class=p>);</span> <span class=c1>// undefined!</span>
<span class=p>})();</span>
</pre></div> </td></tr></table> <h2 id=variable-environment>Variable environment<a class=headerlink href=#variable-environment title="Permanent link">&para;</a></h2> <p>Variable environment component is exactly the initial storage of variables and functions of the context. Exactly its environment record is used as the data storage and is filled on entering the context stage. This is very <strong>variable object</strong> from ES3.</p> <p>When entering the context of a function, recall also that a special <code>arguments</code> object is created which stores the values of formal parameters. In the <em>strict mode</em>, the <code>arguments</code> object has undergone several changes among which are that the <code>arguments</code>does <em>not</em> share anymore values of its properties and real argument variables. Property <code>callee</code> (the reference to the function itself) was also deprecated in strict mode.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>function</span> <span class=nx>foo</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
<span class=p>}</span>

<span class=nx>foo</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</pre></div> </td></tr></table> <p>abstractly we have the following <code>VariableEnvironment</code> component of the <code>foo</code> function context:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nx>fooContext</span><span class=p>.</span><span class=nx>VariableEnvironment</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span>
    <span class=nx>arguments</span><span class=o>:</span> <span class=p>{</span><span class=mi>0</span><span class=o>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nx>length</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>callee</span><span class=o>:</span> <span class=nx>foo</span><span class=p>},</span>
    <span class=nx>a</span><span class=o>:</span> <span class=mi>10</span><span class=p>,</span>
    <span class=nx>b</span><span class=o>:</span> <span class=mi>20</span>
  <span class=p>},</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>globalEnvironment</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <p>So what is <code>LexicalEnvironment</code> component then? The funny thing is that <em>initially</em> it’s just a <em>copy</em> of the <code>VariableEnvironment</code>.</p> <h2 id=lexical-environment>Lexical environment<a class=headerlink href=#lexical-environment title="Permanent link">&para;</a></h2> <p>Both <code>VariableEnvironment</code> and <code>LexicalEnvironment</code> by their nature are <em>lexical environments</em> (regardless possible confusion in their naming), i.e. both statically <em>(lexically)</em> captures the outer bindings for inner functions created in the context.</p> <p>As we’ve just mentioned, initially (when the context is activated) the <code>LexicalEnvironment</code> component is just the blue-print <em>copy</em> of the <code>VariableEnvironment</code>. Considering the example from above, we have:</p> <p><code>fooContext.LexicalEnvironment = copy(fooContext.VariableEnvironment);</code></p> <p>However what happens next, at <strong>code execution stage</strong>, is already related with the augmenting of the lexical environment by the with statements and catch clauses (though, as we said, in ES5 it’s already replacement of the context’s environment, but not augmentation as it was in ES3).</p> <p>The <code>with</code> statement and <code>catch</code> clause as was shown above <em>replace</em> the context’s environment for the time of their execution. And this case is related with <em>function expressions</em>.</p> <p>From discussed rules of function creation, we know that a <em>closure</em> saves the lexical environment of the context in which it is created.</p> <p>If a function expression (FE) is created inside a <code>with</code> statement (or a <code>catch</code> clause), it <em>should</em> save exactly <em>this current (replaced)</em> lexical environment.</p> <p>Had we replaced the <code>VariableEnvironment</code> itself (instead of copied <code>LexicalEnvironment</code>), then we should have been <em>restore</em> it back after the <code>with</code> is completed. However this would mean, that FE would not be able to refer bindings which were created <em>during</em> the <code>with</code> statement execution, but the FE is needed these <code>with</code>-bindings.</p> <p>Moreover, we can’t replace <code>VariableEnvironment</code> itself, because a FD can be also <em>called</em> inside the <code>with</code> statement, but in contrast with FE, FD should continue use binding values from initial state, and not from the <code>with</code>-object (we’ll see it on example below).</p> <p>This is why, closures formed as <em>function declarations</em> (FD) save the <code>VariableEnvironment</code> component as their <code>[[Scope]]</code> property, and function expressions (FE) save exactly <code>LexicalEnvironment</code> component in this case. This is the main (and actually the only) reason of separation of these two, at first glance the same, components.</p> <p>This fact becomes even more funny if to take into account that <code>with</code> statement is going to disappear completely from ES (in ES.next) as it did in ES5-strict. Once it’s happened, ES spec will be less confusing in this respect.</p> <p>So let’s show again what we’ve just analyzed: FE saves <code>LexicalEnvironment</code>, since it’s needed the dynamic bindings created during the <code>with</code> execution, and FD saves <code>VariableEnvironment</code> since, by the spec cannot be created inside a block at all and is hoisted to the top.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=c1>// FD</span>
<span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>a</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>with</span> <span class=p>({</span><span class=nx>a</span><span class=o>:</span> <span class=mi>20</span><span class=p>})</span> <span class=p>{</span>

  <span class=c1>// FE</span>
  <span class=kd>var</span> <span class=nx>bar</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>a</span><span class=p>);</span>
  <span class=p>};</span>

  <span class=nx>foo</span><span class=p>();</span> <span class=c1>// 10!, from VariableEnvrionment</span>
  <span class=nx>bar</span><span class=p>();</span> <span class=c1>// 20,  from LexicalEnvrionment</span>

<span class=p>}</span>

<span class=nx>foo</span><span class=p>();</span> <span class=c1>// 10</span>
<span class=nx>bar</span><span class=p>();</span> <span class=c1>// still 20</span>
</pre></div> </td></tr></table> <p>Schematically it looks like:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// &quot;foo&quot; is created</span>
<span class=nx>foo</span><span class=p>.[[</span><span class=nx>Scope</span><span class=p>]]</span> <span class=o>=</span> <span class=nx>globalContext</span><span class=p>.[[</span><span class=nx>VariableEnvironment</span><span class=p>]];</span>

<span class=c1>// &quot;with&quot; is executed</span>
<span class=nx>previousEnvironment</span> <span class=o>=</span> <span class=nx>globalContext</span><span class=p>.[[</span><span class=nx>LexicalEnvironment</span><span class=p>]];</span>

<span class=nx>globalContext</span><span class=p>.[[</span><span class=nx>LexicalEnvironment</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>environmentRecord</span><span class=o>:</span> <span class=p>{</span><span class=nx>a</span><span class=o>:</span> <span class=mi>20</span><span class=p>},</span>
  <span class=nx>outer</span><span class=o>:</span> <span class=nx>previousEnvironment</span>
<span class=p>};</span>

<span class=c1>// &quot;bar&quot; is created</span>
<span class=nx>bar</span><span class=p>.[[</span><span class=nx>Scope</span><span class=p>]]</span> <span class=o>=</span> <span class=nx>globalContext</span><span class=p>.[[</span><span class=nx>LexicalEnvironment</span><span class=p>]];</span>

<span class=c1>// &quot;with&quot; is completed, restore the environment</span>
<span class=nx>globalContext</span><span class=p>.[[</span><span class=nx>LexicalEnvironment</span><span class=p>]]</span> <span class=o>=</span> <span class=nx>previousEnvironment</span><span class=p>;</span>
</pre></div> </td></tr></table> <h1 id=difference-between-variable-environment-and-lexical-environment>Difference between Variable environment and Lexical environment<a class=headerlink href=#difference-between-variable-environment-and-lexical-environment title="Permanent link">&para;</a></h1> <p>Those are just different names used to refer to the same type of entity (Lexical Environment). They have different names due to different purposes.</p> <p>The LexicalEnvironment and VariableEnvironment components of an execution context are always Lexical Environments. When an execution context is created its LexicalEnvironment and VariableEnvironment components initially have the same value. The value of the VariableEnvironment component never changes while the value of the LexicalEnvironment component may change during execution of code within an execution context.</p> <p>Concept that is important to understand is <em>hoisting</em>: In JavaScript, any variable declaration var x=v; is split into two parts:The declaration is moved to the beginning of the surrounding function as var x;.The initializer becomes a simple assignment x=v; that replaces the declaration. This dominance of the function scope is the main motivation for keeping two current environments, as we shall see below.</p> <h2 id=data-structure>Data structure<a class=headerlink href=#data-structure title="Permanent link">&para;</a></h2> <p><img alt=data_structures.jpg src=../assets/data_structures.jpg></p> <p><strong>A (lexical) environment is the following data structure:</strong></p> <ul> <li>A reference to the outer environment (null in the global environment).</li> <li>An <em>environment record</em> maps identifiers to values. There are two kinds of environment records:<ul> <li>declarative environment records: store the effects of variable declarations, and function declarations.</li> <li>object environment records: are used by the with statement and for the global environment. They turn an object into an environment. For with, that is the argument of the statement. For the global environment, that is the global object.</li> </ul> </li> </ul> <p><strong>An execution context has the following fields:</strong></p> <ul> <li> <p>Environments: two references to environments.</p> <ul> <li>ThisBinding: the current value of this.</li> <li>LexicalEnvironment (lookup and change existing): resolve identifiers.</li> <li>VariableEnvironment (add new): hold bindings made by variable declarations and function declarations.</li> </ul> </li> </ul> <p>Both are usually the same. The next sections explain situations where they diverge.</p> <h2 id=handling-temporary-scopes-via-lexicalenvironment-and-variableenvironment>Handling temporary scopes via LexicalEnvironment and VariableEnvironment<a class=headerlink href=#handling-temporary-scopes-via-lexicalenvironment-and-variableenvironment title="Permanent link">&para;</a></h2> <p><img alt=temporary_scopes.jpg src=../assets/temporary_scopes.jpg></p> <p>LexicalEnvironment and VariableEnvironment are always the same, except in one case: When there is a dominant outer scope and one temporarily wants to enter an inner scope. In the inner scope, a few new bindings should be accessible, but all new bindings made inside of it should be added to the outer scope. This is done as follows:</p> <ul> <li>LexicalEnvironment temporarily points to a new environment that has been put in front of the old LexicalEnvironment. The new environment holds the temporary bindings of the inner scope.</li> <li>VariableEnvironment does not change its value and is thus still the same as the old LexicalEnvironment, denoting the outer scope. New bindings are added here and will also be found when doing a lookup via LexicalEnvironment, because the latter comes before the former in the environment chain.</li> <li>After leaving the temporary scope, LexicalEnvironment’s old value is restored and it is again the same as VariableEnvironment.</li> </ul> <p>These differences matter for with statements and catch clauses, which create temporary scopes. In both cases, the dominant scope is the surrounding function.</p> <ol> <li>with statement: the object that is the argument of the statement becomes a temporary environment.</li> <li>catch clause: the exception that is the argument of this clause is made available via a temporary environment.</li> </ol> <h2 id=functions-and-their-scope-declarations-versus-expressions>Functions and their scope: declarations versus expressions<a class=headerlink href=#functions-and-their-scope-declarations-versus-expressions title="Permanent link">&para;</a></h2> <p>Another area where the difference between LexicalEnvironment and VariableEnvironment can be observed are function definitions: function declarations use the VariableEnvironment as scope, while function expressions use the LexicalEnvironment. For function declarations, the motivation is to move the declaration to the (dominant) function scope. They should thus only see what exists at that level. The following code example illustrates how that works.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>foo</span> <span class=o>=</span> <span class=s2>&quot;abc&quot;</span><span class=p>;</span>
    <span class=kd>with</span><span class=p>({</span> <span class=nx>foo</span><span class=o>:</span> <span class=s2>&quot;bar&quot;</span> <span class=p>})</span> <span class=p>{</span>
       <span class=kd>function</span> <span class=nx>f</span><span class=p>()</span> <span class=p>{</span>
           <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>);</span>
       <span class=p>}</span>
       <span class=nx>f</span><span class=p>();</span>
    <span class=p>}</span>
</pre></div> </td></tr></table> <p>Console output is “bar” on Firefox and Rhino, “abc” on V8 (Chrome, node.js). The latter more closely mirrors the specification, the former is probably what most programmers would expect. If you instead use a function expression, the output is “bar” on all platforms.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>foo</span> <span class=o>=</span> <span class=s2>&quot;abc&quot;</span><span class=p>;</span>
    <span class=kd>with</span><span class=p>({</span> <span class=nx>foo</span><span class=o>:</span> <span class=s2>&quot;bar&quot;</span> <span class=p>})</span> <span class=p>{</span>
        <span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>);</span> <span class=p>}());</span>
    <span class=p>}</span>
</pre></div> </td></tr></table> <h1 id=identifier-resolution>Identifier resolution<a class=headerlink href=#identifier-resolution title="Permanent link">&para;</a></h1> <p>Identifier resolution is the process of determining the binding of an identifier appeared in the context using the <code>LexicalEnvironment</code> component of the running execution context.</p> <p>In other words, it’s the very scope chain lookup of variables. As we have said above, it’s similar to the prototype chain look up, just instead of prototype link, the <code>outer</code> link of an environment is considered.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

<span class=p>(</span><span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span>

  <span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>

  <span class=p>(</span><span class=kd>function</span> <span class=nx>bar</span><span class=p>()</span> <span class=p>{</span>

    <span class=kd>var</span> <span class=nx>c</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>a</span> <span class=o>+</span> <span class=nx>b</span> <span class=o>+</span> <span class=nx>c</span><span class=p>);</span> <span class=c1>// 60</span>

  <span class=p>})();</span>

<span class=p>})();</span>
</pre></div> </td></tr></table> <p>the identifier resolution for e.g. <code>a</code> binding is recursively managed with the following algorithm:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>function</span> <span class=nx>resolveIdentifier</span><span class=p>(</span><span class=nx>lexicalEnvironment</span><span class=p>,</span> <span class=nx>identifier</span><span class=p>)</span> <span class=p>{</span>

  <span class=c1>// if it&#39;s the final link, and we didn&#39;t find</span>
  <span class=c1>// anything, we have a case of a reference error</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>lexicalEnvironment</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=nx>ReferenceError</span><span class=p>(</span><span class=nx>identifier</span> <span class=o>+</span> <span class=s2>&quot; is not defined&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// return the binding (reference) if it exists;</span>
  <span class=c1>// later we&#39;ll be able to get the value from the reference</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>lexicalEnvironment</span><span class=p>.</span><span class=nx>hasBinding</span><span class=p>(</span><span class=nx>identifier</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=nx>Reference</span><span class=p>(</span><span class=nx>lexicalEnvironment</span><span class=p>,</span> <span class=nx>identifier</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// else try to find in the parent scope,</span>
  <span class=c1>// recursively analyzing the outer environment</span>
  <span class=k>return</span> <span class=nx>resolveIdentifier</span><span class=p>(</span><span class=nx>lexicalEnvironment</span><span class=p>.</span><span class=nx>outer</span><span class=p>,</span> <span class=nx>identifier</span><span class=p>);</span>

<span class=p>}</span>

<span class=nx>resolveIdentifier</span><span class=p>(</span><span class=nx>bar</span><span class=p>.[[</span><span class=nx>LexicalEnvironment</span><span class=p>]],</span> <span class=s2>&quot;a&quot;</span><span class=p>)</span> <span class=o>-&gt;</span>

<span class=o>--</span> <span class=nx>bar</span><span class=p>.[[</span><span class=nx>LexicalEnvironment</span><span class=p>]]</span> <span class=o>-</span> <span class=nx>not</span> <span class=nx>found</span><span class=p>,</span>
<span class=o>--</span> <span class=nx>bar</span><span class=p>.[[</span><span class=nx>LexicalEnvironment</span><span class=p>]].</span><span class=nx>outer</span> <span class=p>(</span><span class=nx>i</span><span class=p>.</span><span class=nx>e</span><span class=p>.</span> <span class=nx>foo</span><span class=p>.[[</span><span class=nx>LexicalEnvironment</span><span class=p>]])</span> <span class=o>-&gt;</span> <span class=nx>not</span> <span class=nx>found</span>
<span class=o>--</span> <span class=nx>bar</span><span class=p>.[[</span><span class=nx>LexicalEnvironment</span><span class=p>]].</span><span class=nx>outer</span><span class=p>.</span><span class=nx>outer</span> <span class=o>-&gt;</span> <span class=nx>found</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>value</span> <span class=mi>10</span>
</pre></div> </td></tr></table> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Abhay Garg </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.c648116f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>