<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Notebook collections"><link href=https://abhaydgarg.github.io/Notebook/index.html/javascript/js/js-number/ rel=canonical><meta name=author content="Abhay Garg"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.2"><title>Javascript number - Notebook</title><link rel=stylesheet href=../../../assets/stylesheets/application.30686662.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono&display=fallback"><style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=blue> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#javascript-number tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-header-nav__button md-logo"> <i class=md-icon></i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Notebook </span> <span class=md-header-nav__topic> Javascript number </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-nav__button md-logo"> <i class=md-icon></i> </a> Notebook </label> <div class=md-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../computer-science/ title=CS class=md-nav__link> CS </a> </li> <li class=md-nav__item> <a href=../../../parser/ title=Parser class=md-nav__link> Parser </a> </li> <li class=md-nav__item> <a href=../../../data-structure-and-algorithms/ title="Data structure and algorithms" class=md-nav__link> Data structure and algorithms </a> </li> <li class=md-nav__item> <a href=../../../oops/ title=OOPS class=md-nav__link> OOPS </a> </li> <li class=md-nav__item> <a href=../../../design-patterns/ title="Design patterns" class=md-nav__link> Design patterns </a> </li> <li class=md-nav__item> <a href=../../../regex/ title=Regex class=md-nav__link> Regex </a> </li> <li class=md-nav__item> <a href=../../../git/ title=GIT class=md-nav__link> GIT </a> </li> <li class=md-nav__item> <a href=../../../css/ title=CSS class=md-nav__link> CSS </a> </li> <li class=md-nav__item> <a href=../../../mysql/ title=MySQL class=md-nav__link> MySQL </a> </li> <li class=md-nav__item> <a href=../../../mongodb/ title=MongoDB class=md-nav__link> MongoDB </a> </li> <li class=md-nav__item> <a href=../../ title=Javascript class=md-nav__link> Javascript </a> </li> <li class=md-nav__item> <a href=../../../nodejs/ title=Node.js class=md-nav__link> Node.js </a> </li> <li class=md-nav__item> <a href=../../../expressjs/ title=Express.js class=md-nav__link> Express.js </a> </li> <li class=md-nav__item> <a href=../../../react/ title=React class=md-nav__link> React </a> </li> <li class=md-nav__item> <a href=../../../linters/ title=Linters class=md-nav__link> Linters </a> </li> <li class=md-nav__item> <a href=../../../graphql/ title=GraphQL class=md-nav__link> GraphQL </a> </li> <li class=md-nav__item> <a href=../../../redux-saga/ title="Redux saga" class=md-nav__link> Redux saga </a> </li> <li class=md-nav__item> <a href=../../../rxjs/ title=RxJS class=md-nav__link> RxJS </a> </li> <li class=md-nav__item> <a href=../../../typescript/ title=Typescript class=md-nav__link> Typescript </a> </li> <li class=md-nav__item> <a href=../../../web-security/ title="Web security" class=md-nav__link> Web security </a> </li> <li class=md-nav__item> <a href=../../../react-native/ title="React native" class=md-nav__link> React native </a> </li> <li class=md-nav__item> <a href=../../../rust/ title=Rust class=md-nav__link> Rust </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#representing-numbers-in-the-scientific-notation class=md-nav__link> Representing numbers in the scientific notation </a> </li> <li class=md-nav__item> <a href=#floating-point-according-to-the-ieee754 class=md-nav__link> Floating point according to the IEEE754 </a> </li> <li class=md-nav__item> <a href=#understanding-how-numbers-are-stored class=md-nav__link> Understanding how numbers are stored </a> </li> <li class=md-nav__item> <a href=#examples-of-how-integers-are-stored class=md-nav__link> Examples of how integers are stored </a> </li> <li class=md-nav__item> <a href=#why-0102-is-not-03 class=md-nav__link> Why 0.1+0.2 is not 0.3 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#representing-01-and-02-in-the-floating-point-format class=md-nav__link> Representing 0.1 and 0.2 in the floating point format </a> </li> <li class=md-nav__item> <a href=#calculating-the-result-of-01-02 class=md-nav__link> Calculating the result of 0.1 + 0.2 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#why-the-for-loop-never-stops class=md-nav__link> Why the for loop never stops </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#numbermax_safe_integer class=md-nav__link> Number.MAX_SAFE_INTEGER </a> </li> <li class=md-nav__item> <a href=#the-never-ending-loop class=md-nav__link> The never ending loop </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/abhaydgarg/Notebook/tree/master/src/javascript/js/js-number.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=javascript-number>Javascript number<a class=headerlink href=#javascript-number title="Permanent link">&para;</a></h1> <p>Most statically typed languages like Java or C have different data types for numbers. For example, if you need to store an integer that is in the range [-128;127] you can use ‘byte’ in Java and ‘char’ in C, which both take up only 1 byte. If you need to store a larger integer, you can use ‘int’ or ‘long’ data types which take up 4 and 8 bytes respectively. There are also separate data types that you can use to store numbers with fractional part — ‘float’ which takes up 4 bytes and ‘double’ with 8 bytes. These are usually referred to as floating point format and we’ll see later where this name comes from.</p> <p>But we don’t have such a variety of number types in JavaScript. According to the ECMAScript standard, there is only one type for numbers and it is the ‘double-precision 64-bit binary format IEEE 754 value’. This type is used to store both integers and fractions and is the equivalent of <code>double</code> data type in Java and C. Some new developers to JavaScript do not realize that and believe that if they use <strong>1</strong> it is stored in 64 bits as:</p> <p><img alt=Image src=../../assets/1_bsjyzWhOZ2YNDwlawneK_w.png></p> <p>while in fact it’s stored as:</p> <p><img alt=Image src=../../assets/1_dQ1IqWxT0Gwi07gsn62vFA.png></p> <p>This misunderstanding may cause a great deal of confusion. Let’s for example, take this loop written in Java:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=o>;</span> <span class=mi>1</span><span class=o>/</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&quot;Count is: &quot;</span> <span class=o>+</span> <span class=n>i</span><span class=o>);</span>
<span class=o>}</span>
</pre></div> </td></tr></table> <p>How long will it run? It’s not difficult to see that it will stop after the first iteration. On the second iteration the counter <code>i</code> will be increased to <code>2</code>, <code>1/2</code> will produce <code>0.5</code> which will be truncated to <code>0</code> since the counter <code>i</code> is an integer and the condition <code>1/2 &gt; 0</code> will evaluate to false. Now what do you think will happen if we write the same loop in JavaScript:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=mi>1</span><span class=o>/</span><span class=nx>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&quot;Count is: &quot;</span> <span class=o>+</span> <span class=nx>i</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>As it turns out this loop will never stop because the result of 1/i is not evaluated as integer, but as a floating point and that leads to very interesting behavior.</p> <p>Those that are unfamiliar with the way JavaScript works usually mention another unexpected behavior that is easy to explain once you understand the language. Adding <code>0.1</code> to <code>0.2</code> produces <code>0.30000000000000004</code>, which means that <code>0.1+0.2</code> is not equal to <code>0.3</code>.</p> <p>It’s interesting that this behavior is often attributed to JavaScript, while it’s pertaining to any language the uses floating point format for numbers. This means that if you use ‘float’ or ‘double’ data types in Java or C you’ll see the same result. Another interesting point is that the result of <code>0.1+0.2</code> is not <code>0.30000000000000004</code> as seen in a browser’s console, but is actually <code>0.3000000000000000444089209850062616169452667236328125</code>.</p> <p>In this article I’d like to explain how floating point numbers work and take a close look at the <em>for loop</em> and <em>0.1+0.2</em> examples alluded earlier.</p> <blockquote> <p>It’s worth mentioning BigInt, a new numeric primitive in JavaScript that can represent integers with arbitrary precision. With <code>_BigInt_</code>s, you can safely store and operate on large integers even beyond the safe integer limit for <code>_Number_</code>s. It was introduced <a href=https://v8.dev/blog/bigint>in V8</a> this year and is supported in <a href=https://developers.google.com/web/updates/2018/05/bigint>Chrome 67+</a> and <a href=http://thecodebarbarian.com/an-overview-of-bigint-in-node-js.html>Node v10.4.0+</a>. You can read more about it <a href=https://developers.google.com/web/updates/2018/05/bigint>here</a>.</p> </blockquote> <h2 id=representing-numbers-in-the-scientific-notation>Representing numbers in the scientific notation<a class=headerlink href=#representing-numbers-in-the-scientific-notation title="Permanent link">&para;</a></h2> <p>Before we start talking about floating point and the IEEE754 standard, we need to first look into what it means to represent a number in the scientific notation. In the general form the number in scientific notation can be represented like this:</p> <p><img alt=Image src=../../assets/1_FoBb3L5tCBu54c1JSo1z5A.png></p> <p><em>Significand</em> shows the number of significant digits. It’s also often referred to as <em>Mantissa</em> or <em>Precision</em>. Zeros are not considered significant; they just hold a place. <em>Base</em> specifies the numeric system base, i.e. <code>10</code> for decimal system and <code>2</code> for binary. <em>Exponent</em> defines by how many places a radix point must be moved to the left or right to obtain an original number.</p> <p>Any number can be represented in the scientific notation. For example, the number <code>2</code> in decimal and binary systems can be represented like this:</p> <p><img alt=Image src=../../assets/1_MDU0hga7csrHdPOWHTu_kA.png></p> <p>An exponent of zero simply shows us that no additional operations should be done to obtain the original number. Let’s see another example — the number <code>0.00000022</code>. The significant numbers here are <code>22</code>, so let’s remove zeros:</p> <p><img alt=Image src=../../assets/1_AsTGOQl6gbLWCVBgjrSuUw.png></p> <p>The calculation above demonstrates why the exponent of the base is decreased if the radix point moved to the right. So, by performing multiplication we refined our original number to have only significand digits:</p> <p><img alt=Image src=../../assets/1_HKEcO_6mfIU2EZSlobFlpw.png></p> <p>Since we used multiplication by <code>8</code>, we had to compensate it by division and this is where negative exponent of <code>8</code> comes from. The same process, only this time the division is used to obtain significand digits, can be performed on the number <code>22300000</code>:</p> <p><img alt=Image src=../../assets/1_gMetjorAQWTFep3sqjPNxA.png></p> <p>This time the radix point was moved to the left and hence the exponent increased. As you can see, the scientific notation is a way to work easily with very large or small numbers. Depending on the exponent, the <em>significant</em> may represent an integer or a number with fractional part. When converting to the original number a negative exponent requires shifting the radix point to the left. The positive exponent requires shifting to the right and usually denotes large integers.</p> <p>It’s also important to understand what a normalized form of a number is. A number is normalized when it is written in scientific notation with one nonzero decimal digit before the radix point. So, if we take our original numbers and represent them in the normalized form they will have the following representations:</p> <p><img alt=Image src=../../assets/1_MJQABIORAWZgnN3A-IQ_eA.png></p> <p>As you may have guessed that the binary numbers will always have <code>1</code> before the radix point. Having numbers represented in the normalized form enables easy comparison of numbers by order of magnitude.</p> <p>Scientific notation can be thought of as a floating point representation of a number. The term <em>floating point</em> refers to the fact that a number’s radix point can “float” — it can be put anywhere relative to the significant digits of the number. And as we’ve learnt, the original position is indicated by the exponent.</p> <h2 id=floating-point-according-to-the-ieee754>Floating point according to the IEEE754<a class=headerlink href=#floating-point-according-to-the-ieee754 title="Permanent link">&para;</a></h2> <p>The IEEE Standard for Floating-Point Arithmetic (IEEE 754) defines many things related to floating point arithmetic, but for the purposes of our exploration we’re interested only in how numbers are stored, rounded and added. I’ve written a very detailed article explaining <a href=https://medium.com/@maximus.koretskyi/how-to-round-binary-fractions-625c8fa3a1af#.e9nykp8sj>how to round binary numbers</a>. Rounding is a frequent operation and occurs when a selected format doesn’t allow enough bits to store a number. It is an important topic so get a good grasp of its mechanics. Now, let’s take a look at how numbers are stored. All examples onward are going to be mostly for numbers in binary system.</p> <h2 id=understanding-how-numbers-are-stored>Understanding how numbers are stored<a class=headerlink href=#understanding-how-numbers-are-stored title="Permanent link">&para;</a></h2> <p>There are two formats defined by the standard that are used most often — single and double precision. They differ in the number of bits each takes up and consequently in the range of numbers each format can store. The approach to translating a number in scientific notation into IEEE754 form is the same for all formats, only the number of bits allocated for mantissa (significand digits) and the exponent differ. IEEE754 floating point allocates bits to store a number sign, its mantissa (significant digits) and exponent. Here is the how it distributes those bits in the double-precision format (64 bit for each number) used by JavaScript’s Number type:</p> <p><img alt=Image src=../../assets/1_V0mPKZLKeAOxZMwspz3Htw.png></p> <p>The sign bit gets 1 bit, exponent — 11 bits and 52 bits are allocated for mantissa (significant). Here is the table that shows the number of bits allocated for each format:</p> <p><img alt=Image src=../../assets/1_j0WQBZnmqURh6EXVZlqQgA.png></p> <p>The exponent is stored in the offset binary format. I’ve written <a href=https://medium.com/@maximus.koretskyi/the-mechanics-behind-exponent-bias-in-floating-point-9b3185083528#.zacphtue3>a detailed article explaining this format</a> and it’s differences against two’s complement. Please take some time to understand this topic as I’ll be using it when translating numbers into floating point format.</p> <h2 id=examples-of-how-integers-are-stored>Examples of how integers are stored<a class=headerlink href=#examples-of-how-integers-are-stored title="Permanent link">&para;</a></h2> <p>To see the bits distribution scheme I outlined above let’s see how the integers <code>1</code> and <code>3</code> are stored. Number <code>1</code> is represented in all numeric systems as <code>1</code> so no conversion is required. It can be represented in scientific form as:</p> <p><img alt=Image src=../../assets/1_TJI9QzWevKj8wCtS57ji3Q.png></p> <p>Here we have a mantissa of 1 and the exponent of 0. Using this information you may assume that the number is represented in floating point like this:</p> <p><img alt=Image src=../../assets/1_aeY_0kjanK1hAy_m8O_n7A.png></p> <p>Let’s see if it’s really the case. Unfortunately, there are no built-in functions in JavaScript that allow you to see the bits pattern of a stored number. But I’ve written a simple JavaScript function that allows taking a look at how numbers are stored regardless of the your computer’s <a href=https://www.cs.umd.edu/class/sum2003/cmsc311/Notes/Data/endian.html>endianess</a>. Here it is:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>function</span> <span class=nx>to64bitFloat</span><span class=p>(</span><span class=nx>number</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>result</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>;</span>
    <span class=kd>var</span> <span class=nx>dv</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=k>new</span> <span class=nx>ArrayBuffer</span><span class=p>(</span><span class=mi>8</span><span class=p>));</span>

    <span class=nx>dv</span><span class=p>.</span><span class=nx>setFloat64</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>number</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>

    <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>var</span> <span class=nx>bits</span> <span class=o>=</span> <span class=nx>dv</span><span class=p>.</span><span class=nx>getUint8</span><span class=p>(</span><span class=nx>i</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>bits</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>bits</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Array</span><span class=p>(</span><span class=mi>8</span> <span class=o>-</span> <span class=nx>bits</span><span class=p>.</span><span class=nx>length</span><span class=p>).</span><span class=nx>fill</span><span class=p>(</span><span class=s1>&#39;0&#39;</span><span class=p>).</span><span class=nx>join</span><span class=p>(</span><span class=s2>&quot;&quot;</span><span class=p>)</span> <span class=o>+</span> <span class=nx>bits</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=nx>result</span> <span class=o>+=</span> <span class=nx>bits</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>So, using it you can see that the number <code>1</code> is stored like this:</p> <p><img alt=Image src=../../assets/1_Td4FnJ5g6c40rCmtwgDXtA.png></p> <p>It’s completely different from the assumptions set above. We have no digits in mantissa and there are <code>1</code>’s in the exponent. Now let’s see why it is so. The first thing we need to understand is that every number is translated from the <em>normalized</em> scientific form. What is the advantage of this? If the first digit before the radix point is always <code>1</code>, then there is no need to store it which gives one extra bit for mantissa digits. When performing mathematical operations this first digit <code>1</code> is prepended back by hardware. Since number <code>1</code> has no digits after the radix point in the normalized form and the first digit before the radix point is not stored, we have nothing to put into mantissa and so it’s all zeros. Now, let’s see where <code>1</code>’s come from in the exponent. I mentioned earlier that exponent is stored as offset binary. If we calculate the offset:</p> <p><img alt=Image src=../../assets/1_qkyFehfYHv14LpzOzFt8Cw.png></p> <p>we can see that this is exactly what we have in the representation. So under offset binary the value stored there is really <code>0</code>. If it’s unclear how the offset gives us <code>0</code> read my article on <a href=https://medium.com/@maximus.koretskyi/the-mechanics-behind-exponent-bias-in-floating-point-9b3185083528#.2q5qxmdn3>offset binary</a>.</p> <p>Let’s use the information we’ve learnt above and try to represent the number <code>3</code> in the floating point form. In binary it is represented as <code>11</code>. If you don’t remember why, check out my very detailed article on <a href=https://medium.com/@maximus.koretskyi/the-simple-math-behind-decimal-binary-conversion-algorithms-d30c967c9724#.vkz0k3jon>decimal-binary conversion algorithms</a>. And upon normalization the number <code>3</code> has this form (numbers in binary):</p> <p><img alt=Image src=../../assets/1_dQlDxxCewJ6Y8o7o-I8_Nw.png></p> <p>After the radix point we have only one digit of <code>1</code> that will be stored in mantissa. As explained earlier the first digit before the radix point is not stored. Also, normalization also gave us the exponent of <code>1</code>. Let’s calculate how it’s represented in offset binary and then we have all the information required:</p> <p><img alt=Image src=../../assets/1_gDHTixUiu3HT2mHVsBTj_Q.png></p> <p>One thing to remember about mantissa is that digits are stored in the exact order they are placed in the scientific form — left to right from radix point. With that in mind, let’s put all numbers in the floating point representation:</p> <p><img alt=Image src=../../assets/1_-yZETIKShb9g9W20BU6CtA.png></p> <p>If you use the function I showed above you’ll see that we came up with the correct representation.</p> <h2 id=why-0102-is-not-03>Why 0.1+0.2 is not 0.3<a class=headerlink href=#why-0102-is-not-03 title="Permanent link">&para;</a></h2> <p>Now that we know how numbers are stored, let’s see what happens in this often-cited example. The quick explanation goes like this:</p> <blockquote> <p>Only fractions with a denominator which is a power of two can be finitely represented in a binary form. Since denominators of 0.1 (1 / 10) and 0.2 (1 / 5) are not powers of two, these numbers can’t be finitely represented in a binary format. In order to store them as a IEEE-754 floating point they have to be rounded to the number of available bits for mantissa — 10 bits for half-precision, 23 bits for single-precision or 52 bits for double-precision. Depending on how many bits of precision are available, the floating-point approximations of 0.1 and 0.2 could be slightly less or greater than there corresponding decimal representations, but never equal. Because of that fact, you’re never going to have 0.1+0.2 == 0.3.</p> </blockquote> <p>This explanation maybe sufficient for some developers, but the best way to see what is going on under the hood is perform all the calculations that the computer is doing yourself. That’s what I’m about to do now.</p> <h3 id=representing-01-and-02-in-the-floating-point-format>Representing 0.1 and 0.2 in the floating point format<a class=headerlink href=#representing-01-and-02-in-the-floating-point-format title="Permanent link">&para;</a></h3> <p>Let’s see the bits pattern for <code>0.1</code> in floating point form. The first thing we need to do is to convert <code>0.1</code> to binary. This can be done using the algorithm of multiplication by <code>2</code>. I explain its mechanics in my article on <a href=https://medium.com/@maximus.koretskyi/the-simple-math-behind-decimal-binary-conversion-algorithms-d30c967c9724#.vkz0k3jon>decimal-binary conversion algorithm</a>. If we convert <code>0.1</code> to binary we get an infinite fraction:</p> <p><img alt=Image src=../../assets/1_47litx2SPldE4_bhytk-ug.png></p> <p>The next step is to represent this number in the normalized scientific notation:</p> <p><img alt=Image src=../../assets/1_qEBApVomEABGVK4eXh09wA.png></p> <p>Since mantissa can only have 52 bits, we need to round our infinite number to 52 bits after the radix point.</p> <p><img alt=Image src=../../assets/1_E1aUp_0BuTREWdtUquhulA.png></p> <p>Using the rounding rules defined by IEEE-754 standard and explained in my article on binary numbers rounding we need to round the number up to:</p> <p><img alt=Image src=../../assets/1_3c2yLvBN5zeQdrVp74-GNg.png></p> <p>The last thing left is to calculate the exponent representation in offset binary:</p> <p><img alt=Image src=../../assets/1_yikpW22OiP6uU85e7w_j3Q.png></p> <p>And when put into floating point format representation the number <code>0.1</code> has the following bits pattern:</p> <p><img alt=Image src=../../assets/1_kx17MFmx0gpX_j8LLYp1uA.png></p> <p>I encourage you to calculate the floating representation of <code>0.2</code> on your own. You should end up with the following representations in the scientific notation and binary:</p> <p><img alt=Image src=../../assets/1_fLRp3gdoDoUbXJ-Fkroo-Q.png></p> <h3 id=calculating-the-result-of-01-02>Calculating the result of 0.1 + 0.2<a class=headerlink href=#calculating-the-result-of-01-02 title="Permanent link">&para;</a></h3> <p>If we assemble the numbers back from their representation as floating point into scientific form, here is what we have:</p> <p><img alt=Image src=../../assets/1_fgpXrDT3m20m0D65vlNDoA.png></p> <p>To add numbers, they need to have equal exponents. The rule says that we need to adjust the number with the smaller exponent to that of the larger. So, let’s adjust the exponent of <code>-4</code> of the first number to have the exponent <code>-3</code> like the second number:</p> <p><img alt=Image src=../../assets/1_WJiNR6IPL_7bhmJ7Jjp48w.png></p> <p>Now we can add the numbers:</p> <p><img alt=Image src=../../assets/1_uS64AitPYwcx_MhF9IVcZw.png></p> <p>Now, the result of the calculation is stored in a floating point format, so we need to normalize the result, round if necessary and calculate the exponent in offset binary.</p> <p><img alt=Image src=../../assets/1_FUwRm1QN4oMrvxdYuTQcSw.png></p> <p>The normalized number falls right in the middle between the rounding options, so we apply tie-breaking rule and round up to the even. This gives the following resulting number in the normalized scientific form:</p> <p><img alt=Image src=../../assets/1_I2wM8yj42guOgiurlplCcw.png></p> <p>And when converted to the floating point format for storing, it has the following bits pattern:</p> <p><img alt=Image src=../../assets/1__yh_ARgX6TT51biAXDbHUA.png></p> <p><strong>This is exactly the bits pattern that is stored when you execute the statement</strong> <code>0.1+0.2</code>.<strong> To get it, the computer has to round three times — one for each number and third time for their sum. When simply 0.3 is stored, the computer performs rounding only once. </strong>This rounding operations lead to different bits pattern stored for<strong> <code>0.1+0.2</code> </strong>and for standalone<strong> <code>0.3</code>.</strong> When JavaScript executes comparison statement <code>0.1+0.2 === 0.3</code>, its these bits pattern that are compared, and since they are different the returned result is <em>false</em>. <strong>If such formats existed than even with rounding the bits pattern would be equal, the</strong> <code>0.1+0.2 === 0.3</code> <strong>would evaluate to</strong> <code>true</code> <strong>regardless of the fact that</strong> <code>0.1</code> <strong>and</strong> <code>0.2</code> <strong>are not finitely representable in binary.</strong></p> <p>Try checking the bits for the number <code>0.3</code> using the function I showed above <em>to64bitFloat(0.3).</em> The pattern will be different than the one we calculated above for the result of <code>0.1+0.2</code>. If you want to know what decimal number the stored bits represent, assemble the bits into the scientific form with zero exponent and convert them into decimal numeric system. The actual decimal number stored for <code>0.1+0.2</code> is <code>0.3000000000000000444089209850062616169452667236328125</code> and for <code>0.3</code> it is <code>0.299999999999999988897769753748434595763683319091796875.</code></p> <h2 id=why-the-for-loop-never-stops>Why the <code>for</code> loop never stops<a class=headerlink href=#why-the-for-loop-never-stops title="Permanent link">&para;</a></h2> <p>The key to understanding why the <em>for</em> loop never stops is the number <code>9007199254740991</code>. Let’s see what is special about that number.</p> <h3 id=numbermax_safe_integer>Number.MAX_SAFE_INTEGER<a class=headerlink href=#numbermax_safe_integer title="Permanent link">&para;</a></h3> <p>If you type Number.MAX_SAFE_INTEGER into console, it outputs our key number <code>9007199254740991</code>. What is so special about that number that it got its own constant? Here is what <a href=http://people.mozilla.org/~jorendorff/es6-draft.html#sec-number.max_safe_integer>ECMAScript Language Specification</a> has to say about it:</p> <blockquote> <p>The value of Number.MAX_SAFE_INTEGER is the largest integer <strong>n</strong> such that n and <strong>n + 1</strong> are both exactly representable as a Number value. The value of Number.MAX_SAFE_INTEGER is <strong>9007199254740991</strong> (2⁵³−1).</p> </blockquote> <p>And <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER>MDN</a> also adds some explanation:</p> <p>Safe in the constant name refers to the ability to represent integers exactly and to correctly compare them. For example, <code>Number.MAX_SAFE_INTEGER + 1 === Number.MAX_SAFE_INTEGER + 2</code> will evaluate to true, which is mathematically incorrect.</p> <p>The first thing to understand is that this is not the largest integer that can be represented. For example, the number <code>9007199254740994</code> which is <code>MAX_SAFE_INTEGER + 3</code> can be safely represented. The maximum number that can be represented can be seen using the constant <code>Number.MAX_VALUE</code> and it’s equal to <code>1.7976931348623157e+308</code>. What may come to you as surprise is that there are some integers that can’t be represented between <code>MAX_SAFE_INTEGER</code> and <code>MAX_VALUE</code>. In fact, there’s an integer that can’t be represented between <code>MAX_SAFE_INTEGER</code> and <code>MAX_SAFE_INTEGER+ 3</code>. This number is <code>9007199254740993</code>. If you type it into console, you will see that it evaluates to <code>9007199254740992</code>. So, instead of working with the original number, JavaScript transformed it into the number less than the original by 1.</p> <p>To understand why that happens, let’s first look at the bits representation of <code>9007199254740991 (MAX_SAFE_INTEGER)</code> in the floating point:</p> <p><img alt=Image src=../../assets/1_jyYOIgmj-5Mfatu8NV3htg.png></p> <p>which when converted to scientific form has the following representation:</p> <p><img alt=Image src=../../assets/1_P60vgnZwLYwU1UbaA2pHsg.png></p> <p>Now, to get the binary resulting number with zero exponent we just move the radix point 52 places to the right and get:</p> <p><img alt=Image src=../../assets/1_uDFvnqHBM1-vwao77rjkeQ.png></p> <p>So, to store the <code>MAX_SAFE_INTEGER</code> number we used all places in the mantissa with the exponent of 52. Since all places are used, to be able to store the next number the only option we have is to increase the exponent by <code>1</code> to <code>53</code>. For the exponent of <code>53</code>, we move the radix point <code>53</code> places to the right. But since we have only <code>52</code> digits in the mantissa, we append <code>0</code> at the end. For the exponent of <code>54</code> two zeros will be appended. For <code>55</code> — three. And so on.</p> <p>What implications does it have? You might have guessed already yourself. <strong>Since we’re going to have all numbers larger than</strong> <code>MAX_SAFE_INTEGER</code> <strong>end with</strong> <code>0</code>, no odd integer larger than<strong> <code>MAX_SAFE_INTEGER</code> </strong>can be represented in 64 bit floating point.** To be able to store some of them, the mantissa should be allocated more than 52 bits. Let’s see this in action:</p> <p><img alt=Image src=../../assets/1_9WgZriHQa0yQZFQLWr-E_A.png></p> <p>You can see that the numbers <code>9007199254740993</code>, <code>9007199254740995</code> can’t be represented in <code>64 bit</code> floating point. As exponent increases, the range of numbers that can’t be stored starts increasing dramatically.</p> <h3 id=the-never-ending-loop>The never ending loop<a class=headerlink href=#the-never-ending-loop title="Permanent link">&para;</a></h3> <p>Let me bring up the example with <code>for</code> loop here again:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=mi>1</span><span class=o>/</span><span class=nx>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&quot;Count is: &quot;</span> <span class=o>+</span> <span class=nx>i</span><span class=p>);</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>It never stops. I mentioned in the beginning that it happens because the the result of <code>1/i</code> is not evaluated as integer, but as a floating point. Now that you know how floating point works and what <code>Number.MAX_SAFE_INTEGER</code> it’s easy to understand why it never stops.</p> <p>For the loop to stop, the counter <code>i</code> would have to reach <code>Infinity</code>, since <code>1/Infinity &gt; 0</code> evaluates to <code>false</code>. Yet it never happens. In the previous paragraph I explained why some integers can’t be stored and that they are rounded to the nearest even. So in our example JavaScript keeps increasing the counter <code>i</code> by <code>1</code> until it reaches <code>9007199254740993</code>, which is <code>MAX_SAFE_INTEGER+2</code>. And this is the first integer that can’t be stored, thus it gets rounded to the nearest even integer <code>9007199254740992</code>. So the loop is stuck at this number. The loop won’t be able to get over it and we’ve got an infinite loop here.</p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Abhay Garg </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.c648116f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>