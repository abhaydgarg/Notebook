<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Notebook collections"><link href=https://abhaydgarg.github.io/Notebook/index.html/rust/box/ rel=canonical><meta name=author content="Abhay Garg"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.2"><title>`Box` to point data on the heap - Notebook</title><link rel=stylesheet href=../../assets/stylesheets/application.30686662.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono&display=fallback"><style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=blue> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#boxlttgt-to-point-data-on-the-heap tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-header-nav__button md-logo"> <i class=md-icon></i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Notebook </span> <span class=md-header-nav__topic> `Box<t>` to point data on the heap </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://abhaydgarg.github.io/Notebook/index.html title=Notebook class="md-nav__button md-logo"> <i class=md-icon></i> </a> Notebook </label> <div class=md-nav__source> <a href=https://github.com/abhaydgarg/Notebook/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../computer-science/ title=CS class=md-nav__link> CS </a> </li> <li class=md-nav__item> <a href=../../parser/ title=Parser class=md-nav__link> Parser </a> </li> <li class=md-nav__item> <a href=../../data-structure-and-algorithms/ title="Data Structure and Algorithms" class=md-nav__link> Data Structure and Algorithms </a> </li> <li class=md-nav__item> <a href=../../oops/ title=OOPS class=md-nav__link> OOPS </a> </li> <li class=md-nav__item> <a href=../../design-patterns/ title="Design Patterns" class=md-nav__link> Design Patterns </a> </li> <li class=md-nav__item> <a href=../../regex/ title=Regex class=md-nav__link> Regex </a> </li> <li class=md-nav__item> <a href=../../git/ title=GIT class=md-nav__link> GIT </a> </li> <li class=md-nav__item> <a href=../../css/ title=CSS class=md-nav__link> CSS </a> </li> <li class=md-nav__item> <a href=../../rest-api/ title="REST API" class=md-nav__link> REST API </a> </li> <li class=md-nav__item> <a href=../../eslint/ title=ESLint class=md-nav__link> ESLint </a> </li> <li class=md-nav__item> <a href=../../javascript/ title=Javascript class=md-nav__link> Javascript </a> </li> <li class=md-nav__item> <a href=../../nodejs/ title=Node.js class=md-nav__link> Node.js </a> </li> <li class=md-nav__item> <a href=../../react/ title=React class=md-nav__link> React </a> </li> <li class=md-nav__item> <a href=../../react-native/ title="React Native" class=md-nav__link> React Native </a> </li> <li class=md-nav__item> <a href=../../redux-saga/ title="Redux Saga" class=md-nav__link> Redux Saga </a> </li> <li class=md-nav__item> <a href=../../rxjs/ title=RxJS class=md-nav__link> RxJS </a> </li> <li class=md-nav__item> <a href=../../mysql/ title=MySQL class=md-nav__link> MySQL </a> </li> <li class=md-nav__item> <a href=../../mongodb/ title=MongoDB class=md-nav__link> MongoDB </a> </li> <li class=md-nav__item> <a href=../../web-security/ title="Web Security" class=md-nav__link> Web Security </a> </li> <li class=md-nav__item> <a href=../ title=Rust class=md-nav__link> Rust </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#usage class=md-nav__link> Usage </a> </li> <li class=md-nav__item> <a href=#recursive-types-with-boxes class=md-nav__link> Recursive types with boxes </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-rust-compute-size-of-non-recursive-type class=md-nav__link> How Rust compute size of non recursive type </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#indirection class=md-nav__link> Indirection </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/abhaydgarg/Notebook/tree/master/src/rust/box.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=boxlttgt-to-point-data-on-the-heap><code>Box&lt;T&gt;</code> to point data on the heap<a class=headerlink href=#boxlttgt-to-point-data-on-the-heap title="Permanent link">&para;</a></h1> <blockquote> <p>Single ownership.</p> </blockquote> <p>The most straightforward smart pointer is a <em>box</em>, whose type is written <code>Box&lt;T&gt;</code>. Boxes allow you to store data on the heap rather than the stack. What remains on the stack is the pointer to the heap data.</p> <p><code>Box&lt;T&gt;</code> owns the data it points to. We call it smart because when it goes out of scope, it will first drop the data it points to and then itself. No manual memory management required.</p> <p><img alt=Box src=../assets/box.png></p> <p>Boxes don’t have performance overhead, other than storing their data on the heap instead of on the stack. But they don’t have many extra capabilities either. You’ll use them most often in these situations:</p> <ul> <li>When you have a type whose size can’t be known at compile time and you want to use a value of that type in a context that requires an exact size</li> <li>When you have a large amount of data and you want to transfer ownership but ensure the data won’t be copied when you do so</li> <li>When you want to own a value and you care only that it’s a type that implements a particular trait rather than being of a specific type</li> </ul> <h2 id=usage>Usage<a class=headerlink href=#usage title="Permanent link">&para;</a></h2> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Box</span>::<span class=n>new</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=s>&quot;b = {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</pre></div> </td></tr></table> <p>We define the variable <code>b</code> to have the value of a <code>Box</code> that points to the value <code>5</code>, which is allocated on the heap. This program will print <code>b = 5</code>; in this case, we can access the data in the box similar to how we would if this data were on the stack. Just like any owned value, when a box goes out of scope, as <code>b</code> does at the end of <code>main</code>, it will be deallocated. The deallocation happens for the box (stored on the stack) and the data it points to (stored on the heap).</p> <h2 id=recursive-types-with-boxes>Recursive types with boxes<a class=headerlink href=#recursive-types-with-boxes title="Permanent link">&para;</a></h2> <blockquote> <p>When you have a type whose size can’t be known at compile time.</p> <p><strong>Rust need size to be known before hand when storing data in stack, for storing data in heap it does not need to know the size before hand.</strong></p> </blockquote> <p><strong>At compile time, Rust needs to know how much space a type takes up.</strong> One type whose size can’t be known at compile time is a recursive type, where a value can have as part of itself another value of the same type. Because this nesting of values could theoretically continue infinitely, Rust doesn’t know how much space a value of a recursive type needs. However, <strong>boxes have a known size</strong> because it is a pointer which need fixed size in stack to store memory address, so by inserting a box in a recursive type definition, you can have recursive types.</p> <h3 id=how-rust-compute-size-of-non-recursive-type>How Rust compute size of non recursive type<a class=headerlink href=#how-rust-compute-size-of-non-recursive-type title="Permanent link">&para;</a></h3> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=mi>111</span><span class=p>;</span><span class=w></span>
</pre></div> </td></tr></table> <p>To determine how much space to allocate for <code>a</code> value, Rust check the type of <code>a</code> which is <code>i32</code>. Now Rust knows how much space is required to allocate for <code>a</code> becuase it knows how much space <code>i32</code> type is used (<code>-(2ⁿ⁻¹) to 2ⁿ⁻¹-1</code>).</p> <p>Let's check example below, a binary tree representation.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// `Tree` is a custom type which is recursive</span>
<span class=k>struct</span> <span class=nc>Tree</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>data</span>: <span class=kt>i64</span><span class=p>,</span><span class=w></span>
<span class=w>  </span><span class=n>left</span>: <span class=nc>Tree</span><span class=p>,</span><span class=w></span>
<span class=w>  </span><span class=n>right</span>: <span class=nc>Tree</span><span class=p>,</span><span class=w></span>
<span class=p>}</span><span class=w></span>
<span class=c1>// Error - recursive type `Tree` has infinite size</span>
</pre></div> </td></tr></table> <p>A tree is a structure containing an <code>i64</code>, and two trees. Each of these trees is a structure containing an <code>i64</code>, and two trees. Each of these...so on. You got an idea. Since we don't know how many subtrees our tree will have, there is no way to tell how much memory we need to allocate up front. We'll only know at runtime.</p> <p>Rust tells us how to fix that: by using <code>Box&lt;T&gt;</code>. Because a <code>Box&lt;T&gt;</code> is a pointer, Rust always knows how much space a <code>Box&lt;T&gt;</code> needs: a pointer’s size doesn’t change based on the amount of data it’s pointing to. See <code>Box&lt;T&gt;</code> is a pointer which contains the memory address, and value of memory address is of fixed size because it is just an address. So Rust store the pointer in stack, so in this way compiler knows the size of <code>Tree</code> type before hand which is combination of size of <code>data: i64 + left: Tree (a pointer size) + right: Tree (a pointer size)</code>. As you know compiler need to know about the size of variable before hand when it is stored in stack. The actual data is stored in a heap which is allocated at runtime because we cannot determine the size of data at compile time.</p> <p>We now know that any <code>Tree</code> value will take up the size of an <code>i64</code> plus the size of a two box’s pointer data. By using a box, we’ve broken the infinite, recursive chain, so the compiler can figure out the size it needs to store a <code>Tree</code> value.</p> <blockquote> <p>Boxes provide only the indirection and heap allocation; they don’t have any other special capabilities, like with the other smart pointer types. They also don’t have any performance overhead that these special capabilities incur, so they can be useful in cases where the indirection is the only feature we need.</p> </blockquote> <h2 id=indirection>Indirection<a class=headerlink href=#indirection title="Permanent link">&para;</a></h2> <p>In computer programming, indirection (also called dereferencing) is the ability to reference something using a name, reference, or container instead of the value itself. The most common form of indirection is the act of manipulating a value through its memory address. For example, accessing a variable through the use of a pointer.</p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Abhay Garg </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.c648116f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>